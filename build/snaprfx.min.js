var JpegMeta=function(){if(this.JpegMeta)return this.JpegMeta;var c=this.JpegMeta={};c.parseNum=function(b,a,c,f){var g,h;b=">"===b;void 0===c&&(c=0);void 0===f&&(f=a.length-c);for(b?g=c:g=c+f-1;b?g<c+f:g>=c;b?g++:g--)h<<=8,h+=a.charCodeAt(g);return h};c.parseSnum=function(b,a,c,f){var g,h,e;b=">"===b;void 0===c&&(c=0);void 0===f&&(f=a.length-c);for(b?g=c:g=c+f-1;b?g<c+f:g>=c;b?g++:g--)void 0===e&&(e=128===(a.charCodeAt(g)&128)),h<<=8,h+=e?~a.charCodeAt(g)&255:a.charCodeAt(g);e&&(h=-1*(h+1));return h};
c.Rational=function(b,a){this.num=b;this.den=a||1;return this};c.Rational.prototype.toString=function(){return 0===this.num||1===this.den?""+this.num:1===this.num?this.num+" / "+this.den:this.num/this.den};c.Rational.prototype.asFloat=function(){return this.num/this.den};c.MetaGroup=function(b,a){this.fieldName=b;this.description=a;this.metaProps={};return this};c.MetaGroup.prototype._addProperty=function(b,a,d){b=new c.MetaProp(b,a,d);this[b.fieldName]=b;this.metaProps[b.fieldName]=b};c.MetaGroup.prototype.toString=
function(){return"[MetaGroup "+this.description+"]"};c.MetaProp=function(b,a,c){this.fieldName=b;this.description=a;this.value=c;return this};c.MetaProp.prototype.toString=function(){return""+this.value};this.JpegMeta.JpegFile=function(b,a){var d=this._SOS;this.metaGroups={};this._binary_data=b;this.filename=a;var f=0,g=0,h,e;if(this._binary_data.slice(0,2)!==this._SOI_MARKER)throw Error("Doesn't look like a JPEG file. First two bytes are "+this._binary_data.charCodeAt(0)+","+this._binary_data.charCodeAt(1)+
".");for(f+=2;f<this._binary_data.length;){h=this._binary_data.charCodeAt(f++);e=this._binary_data.charCodeAt(f++);g=f;if(h!=this._DELIM)break;if(e===d)break;h=c.parseNum(">",this._binary_data,f,2);for(f+=h;f<this._binary_data.length;)if(h=this._binary_data.charCodeAt(f++),h==this._DELIM&&(h=this._binary_data.charCodeAt(f++),0!=h)){f-=2;break}if(h=this._markers[e]?this._markers[e][1]:void 0)this[h](e,g+2)}if(void 0===this.general)throw Error("Invalid JPEG file.");return this};this.JpegMeta.JpegFile.prototype.toString=
function(){return"[JpegFile "+this.filename+" "+this.general.type+" "+this.general.pixelWidth+"x"+this.general.pixelHeight+" Depth: "+this.general.depth+"]"};this.JpegMeta.JpegFile.prototype._SOI_MARKER="\u00ff\u00d8";this.JpegMeta.JpegFile.prototype._DELIM=255;this.JpegMeta.JpegFile.prototype._EOI=217;this.JpegMeta.JpegFile.prototype._SOS=218;this.JpegMeta.JpegFile.prototype._sofHandler=function(b,a){if(void 0!==this.general)throw Error("Unexpected multiple-frame image");this._addMetaGroup("general",
"General");this.general._addProperty("depth","Depth",c.parseNum(">",this._binary_data,a,1));this.general._addProperty("pixelHeight","Pixel Height",c.parseNum(">",this._binary_data,a+1,2));this.general._addProperty("pixelWidth","Pixel Width",c.parseNum(">",this._binary_data,a+3,2));this.general._addProperty("type","Type",this._markers[b][2])};this.JpegMeta.JpegFile.prototype._JFIF_IDENT="JFIF\x00";this.JpegMeta.JpegFile.prototype._JFXX_IDENT="JFXX\x00";this.JpegMeta.JpegFile.prototype._EXIF_IDENT=
"Exif\x00";this.JpegMeta.JpegFile.prototype._types={1:["BYTE",1],2:["ASCII",1],3:["SHORT",2],4:["LONG",4],5:["RATIONAL",8],6:["SBYTE",1],7:["UNDEFINED",1],8:["SSHORT",2],9:["SLONG",4],10:["SRATIONAL",8],11:["FLOAT",4],12:["DOUBLE",8]};this.JpegMeta.JpegFile.prototype._tifftags={256:["Image width","ImageWidth"],257:["Image height","ImageLength"],258:["Number of bits per component","BitsPerSample"],259:["Compression scheme","Compression",{1:"uncompressed",6:"JPEG compression"}],262:["Pixel composition",
"PhotmetricInerpretation",{2:"RGB",6:"YCbCr"}],274:["Orientation of image","Orientation",{1:"Normal",2:"Reverse?",3:"Upside-down",4:"Upside-down Reverse",5:"90 degree CW",6:"90 degree CW reverse",7:"90 degree CCW",8:"90 degree CCW reverse"}],277:["Number of components","SamplesPerPixel"],284:["Image data arrangement","PlanarConfiguration",{1:"chunky format",2:"planar format"}],530:["Subsampling ratio of Y to C","YCbCrSubSampling"],531:["Y and C positioning","YCbCrPositioning",{1:"centered",2:"co-sited"}],
282:["X Resolution","XResolution"],283:["Y Resolution","YResolution"],296:["Resolution Unit","ResolutionUnit",{2:"inches",3:"centimeters"}],273:["Image data location","StripOffsets"],278:["Number of rows per strip","RowsPerStrip"],279:["Bytes per compressed strip","StripByteCounts"],513:["Offset to JPEG SOI","JPEGInterchangeFormat"],514:["Bytes of JPEG Data","JPEGInterchangeFormatLength"],301:["Transfer function","TransferFunction"],318:["White point chromaticity","WhitePoint"],319:["Chromaticities of primaries",
"PrimaryChromaticities"],529:["Color space transformation matrix coefficients","YCbCrCoefficients"],532:["Pair of black and white reference values","ReferenceBlackWhite"],306:["Date and time","DateTime"],270:["Image title","ImageDescription"],271:["Make","Make"],272:["Model","Model"],305:["Software","Software"],315:["Person who created the image","Artist"],316:["Host Computer","HostComputer"],33432:["Copyright holder","Copyright"],34665:["Exif tag","ExifIfdPointer"],34853:["GPS tag","GPSInfoIfdPointer"]};
this.JpegMeta.JpegFile.prototype._exiftags={36864:["Exif Version","ExifVersion"],40960:["FlashPix Version","FlashpixVersion"],40961:["Color Space","ColorSpace"],37121:["Meaning of each component","ComponentsConfiguration"],37122:["Compressed Bits Per Pixel","CompressedBitsPerPixel"],40962:["Pixel X Dimension","PixelXDimension"],40963:["Pixel Y Dimension","PixelYDimension"],37500:["Manufacturer notes","MakerNote"],37510:["User comments","UserComment"],40964:["Related audio file","RelatedSoundFile"],
36867:["Date Time Original","DateTimeOriginal"],36868:["Date Time Digitized","DateTimeDigitized"],37520:["DateTime subseconds","SubSecTime"],37521:["DateTimeOriginal subseconds","SubSecTimeOriginal"],37522:["DateTimeDigitized subseconds","SubSecTimeDigitized"],33434:["Exposure time","ExposureTime"],33437:["FNumber","FNumber"],34850:["Exposure program","ExposureProgram"],34852:["Spectral sensitivity","SpectralSensitivity"],34855:["ISO Speed Ratings","ISOSpeedRatings"],34856:["Optoelectric coefficient",
"OECF"],37377:["Shutter Speed","ShutterSpeedValue"],37378:["Aperture Value","ApertureValue"],37379:["Brightness","BrightnessValue"],37380:["Exposure Bias Value","ExposureBiasValue"],37381:["Max Aperture Value","MaxApertureValue"],37382:["Subject Distance","SubjectDistance"],37383:["Metering Mode","MeteringMode"],37384:["Light Source","LightSource"],37385:["Flash","Flash"],37386:["Focal Length","FocalLength"],37396:["Subject Area","SubjectArea"],41483:["Flash Energy","FlashEnergy"],41484:["Spatial Frequency Response",
"SpatialFrequencyResponse"],41486:["Focal Plane X Resolution","FocalPlaneXResolution"],41487:["Focal Plane Y Resolution","FocalPlaneYResolution"],41488:["Focal Plane Resolution Unit","FocalPlaneResolutionUnit"],41492:["Subject Location","SubjectLocation"],41493:["Exposure Index","ExposureIndex"],41495:["Sensing Method","SensingMethod"],41728:["File Source","FileSource"],41729:["Scene Type","SceneType"],41730:["CFA Pattern","CFAPattern"],41985:["Custom Rendered","CustomRendered"],41986:["Exposure Mode",
"Exposure Mode"],41987:["White Balance","WhiteBalance"],41988:["Digital Zoom Ratio","DigitalZoomRatio"],41990:["Scene Capture Type","SceneCaptureType"],41991:["Gain Control","GainControl"],41992:["Contrast","Contrast"],41993:["Saturation","Saturation"],41994:["Sharpness","Sharpness"],41995:["Device settings description","DeviceSettingDescription"],41996:["Subject distance range","SubjectDistanceRange"],42016:["Unique image ID","ImageUniqueID"],40965:["Interoperability tag","InteroperabilityIFDPointer"]};
this.JpegMeta.JpegFile.prototype._gpstags={"0":["GPS tag version","GPSVersionID"],1:["North or South Latitude","GPSLatitudeRef"],2:["Latitude","GPSLatitude"],3:["East or West Longitude","GPSLongitudeRef"],4:["Longitude","GPSLongitude"],5:["Altitude reference","GPSAltitudeRef"],6:["Altitude","GPSAltitude"],7:["GPS time (atomic clock)","GPSTimeStamp"],8:["GPS satellites usedd for measurement","GPSSatellites"],9:["GPS receiver status","GPSStatus"],10:["GPS mesaurement mode","GPSMeasureMode"],11:["Measurement precision",
"GPSDOP"],12:["Speed unit","GPSSpeedRef"],13:["Speed of GPS receiver","GPSSpeed"],14:["Reference for direction of movement","GPSTrackRef"],15:["Direction of movement","GPSTrack"],16:["Reference for direction of image","GPSImgDirectionRef"],17:["Direction of image","GPSImgDirection"],18:["Geodetic survey data used","GPSMapDatum"],19:["Reference for latitude of destination","GPSDestLatitudeRef"],20:["Latitude of destination","GPSDestLatitude"],21:["Reference for longitude of destination","GPSDestLongitudeRef"],
22:["Longitude of destination","GPSDestLongitude"],23:["Reference for bearing of destination","GPSDestBearingRef"],24:["Bearing of destination","GPSDestBearing"],25:["Reference for distance to destination","GPSDestDistanceRef"],26:["Distance to destination","GPSDestDistance"],27:["Name of GPS processing method","GPSProcessingMethod"],28:["Name of GPS area","GPSAreaInformation"],29:["GPS Date","GPSDateStamp"],30:["GPS differential correction","GPSDifferential"]};this.JpegMeta.JpegFile.prototype._markers=
{192:["SOF0","_sofHandler","Baseline DCT"],193:["SOF1","_sofHandler","Extended sequential DCT"],194:["SOF2","_sofHandler","Progressive DCT"],195:["SOF3","_sofHandler","Lossless (sequential)"],197:["SOF5","_sofHandler","Differential sequential DCT"],198:["SOF6","_sofHandler","Differential progressive DCT"],199:["SOF7","_sofHandler","Differential lossless (sequential)"],200:["JPG",null,"Reserved for JPEG extensions"],201:["SOF9","_sofHandler","Extended sequential DCT"],202:["SOF10","_sofHandler","Progressive DCT"],
203:["SOF11","_sofHandler","Lossless (sequential)"],205:["SOF13","_sofHandler","Differential sequential DCT"],206:["SOF14","_sofHandler","Differential progressive DCT"],207:["SOF15","_sofHandler","Differential lossless (sequential)"],196:["DHT",null,"Define Huffman table(s)"],204:["DAC",null,"Define arithmetic coding conditioning(s)"],208:["RST0",null,"Restart with modulo 8 count \u201c0\u201d"],209:["RST1",null,"Restart with modulo 8 count \u201c1\u201d"],210:["RST2",null,"Restart with modulo 8 count \u201c2\u201d"],
211:["RST3",null,"Restart with modulo 8 count \u201c3\u201d"],212:["RST4",null,"Restart with modulo 8 count \u201c4\u201d"],213:["RST5",null,"Restart with modulo 8 count \u201c5\u201d"],214:["RST6",null,"Restart with modulo 8 count \u201c6\u201d"],215:["RST7",null,"Restart with modulo 8 count \u201c7\u201d"],216:["SOI",null,"Start of image"],217:["EOI",null,"End of image"],218:["SOS",null,"Start of scan"],219:["DQT",null,"Define quantization table(s)"],220:["DNL",null,"Define number of lines"],221:["DRI",
null,"Define restart interval"],222:["DHP",null,"Define hierarchical progression"],223:["EXP",null,"Expand reference component(s)"],224:["APP0","_app0Handler","Reserved for application segments"],225:["APP1","_app1Handler"],226:["APP2",null],227:["APP3",null],228:["APP4",null],229:["APP5",null],230:["APP6",null],231:["APP7",null],232:["APP8",null],233:["APP9",null],234:["APP10",null],235:["APP11",null],236:["APP12",null],237:["APP13",null],238:["APP14",null],239:["APP15",null],240:["JPG0",null],241:["JPG1",
null],242:["JPG2",null],243:["JPG3",null],244:["JPG4",null],245:["JPG5",null],246:["JPG6",null],247:["JPG7",null],248:["JPG8",null],249:["JPG9",null],250:["JPG10",null],251:["JPG11",null],252:["JPG12",null],253:["JPG13",null],254:["COM",null],1:["JPG13",null]};this.JpegMeta.JpegFile.prototype._addMetaGroup=function(b,a){var d=new c.MetaGroup(b,a);this[d.fieldName]=d;return this.metaGroups[d.fieldName]=d};this.JpegMeta.JpegFile.prototype._parseIfd=function(b,a,d,f,g,h,e){var l=c.parseNum(b,a,d+f,2),
k,n,m,p,q,r,s,t,u;u=this._addMetaGroup(h,e);for(h=0;h<l;h++)if(k=d+f+2+12*h,e=c.parseNum(b,a,k,2),m=c.parseNum(b,a,k+2,2),p=c.parseNum(b,a,k+4,4),q=c.parseNum(b,a,k+8,4),void 0!==this._types[m]){n=this._types[m][0];m=this._types[m][1];q=4>=m*p?k+8:d+q;if("UNDEFINED"==n)r=a.slice(q,q+p);else if("ASCII"==n)r=a.slice(q,q+p),r=r.split("\x00")[0];else{r=[];for(k=0;k<p;k++,q+=m)("BYTE"==n||"SHORT"==n||"LONG"==n)&&r.push(c.parseNum(b,a,q,m)),("SBYTE"==n||"SSHORT"==n||"SLONG"==n)&&r.push(c.parseSnum(b,a,
q,m)),"RATIONAL"==n&&(s=c.parseNum(b,a,q,4),t=c.parseNum(b,a,q+4,4),r.push(new c.Rational(s,t))),"SRATIONAL"==n&&(s=c.parseSnum(b,a,q,4),t=c.parseSnum(b,a,q+4,4),r.push(new c.Rational(s,t))),r.push();1===p&&(r=r[0])}null!=g[e]&&u._addProperty(g[e][1],g[e][0],r)}};this.JpegMeta.JpegFile.prototype._jfifHandler=function(b,a){if(void 0!==this.jfif)throw Error("Multiple JFIF segments found");this._addMetaGroup("jfif","JFIF");this.jfif._addProperty("version_major","Version Major",this._binary_data.charCodeAt(a+
5));this.jfif._addProperty("version_minor","Version Minor",this._binary_data.charCodeAt(a+6));this.jfif._addProperty("version","JFIF Version",this.jfif.version_major.value+"."+this.jfif.version_minor.value);this.jfif._addProperty("units","Density Unit",this._binary_data.charCodeAt(a+7));this.jfif._addProperty("Xdensity","X density",c.parseNum(">",this._binary_data,a+8,2));this.jfif._addProperty("Ydensity","Y Density",c.parseNum(">",this._binary_data,a+10,2));this.jfif._addProperty("Xthumbnail","X Thumbnail",
c.parseNum(">",this._binary_data,a+12,1));this.jfif._addProperty("Ythumbnail","Y Thumbnail",c.parseNum(">",this._binary_data,a+13,1))};this.JpegMeta.JpegFile.prototype._app0Handler=function(b,a){this._binary_data.slice(a,a+5)==this._JFIF_IDENT&&this._jfifHandler(b,a)};this.JpegMeta.JpegFile.prototype._app1Handler=function(b,a){this._binary_data.slice(a,a+5)==this._EXIF_IDENT&&this._exifHandler(b,a+6)};c.JpegFile.prototype._exifHandler=function(b,a){if(void 0!==this.exif)throw Error("Multiple JFIF segments found");
var d,f;d=this._binary_data.slice(a,a+2);if("II"===d)d="<";else if("MM"===d)d=">";else throw Error("Malformed TIFF meta-data. Unknown endianess: "+d);f=c.parseNum(d,this._binary_data,a+2,2);if(42!==f)throw Error("Malformed TIFF meta-data. Bad magic: "+f);f=c.parseNum(d,this._binary_data,a+4,4);this._parseIfd(d,this._binary_data,a,f,this._tifftags,"tiff","TIFF");this.tiff.ExifIfdPointer&&this._parseIfd(d,this._binary_data,a,this.tiff.ExifIfdPointer.value,this._exiftags,"exif","Exif");this.tiff.GPSInfoIfdPointer&&
(this._parseIfd(d,this._binary_data,a,this.tiff.GPSInfoIfdPointer.value,this._gpstags,"gps","GPS"),this.gps.GPSLatitude&&(d=this.gps.GPSLatitude.value[0].asFloat()+1/60*this.gps.GPSLatitude.value[1].asFloat()+1/3600*this.gps.GPSLatitude.value[2].asFloat(),"S"===this.gps.GPSLatitudeRef.value&&(d=-d),this.gps._addProperty("latitude","Dec. Latitude",d)),this.gps.GPSLongitude&&(d=this.gps.GPSLongitude.value[0].asFloat()+1/60*this.gps.GPSLongitude.value[1].asFloat()+1/3600*this.gps.GPSLongitude.value[2].asFloat(),
"W"===this.gps.GPSLongitudeRef.value&&(d=-d),this.gps._addProperty("longitude","Dec. Longitude",d)))};return this.JpegMeta}();var debug_logging=!1,debug_canvas=!1,R=0,G=1,B=2,O=3,SnaprFX=function(c){return this.init(c)};window.SnaprFX=SnaprFX;SnaprFX.prototype.deferred=null;
SnaprFX.prototype.init=function(c){var b=this;b.deferred=$.Deferred();b.options=c;b.render_options={editable:!1,width:b.options.width,height:b.options.height};SnaprFX.utils.read_exif(b.options.url).done(function(a){b.exif=a;b.load_original(!0).done(function(){b.canvas=new SnaprFX.Canvas({width:b.original.width,height:b.original.height});b.canvas.context.drawImage(b.original.canvas,0,0);b.update_element();setTimeout(function(){b.create_overlay_elements();b.deferred.resolve()},1)})});b.load_filter_pack=
$.Deferred();$.ajax({url:b.options.filter_pack+"filter-pack.json",success:function(a){b.filter_pack=a.filter_pack;b.filter_pack.base_path=b.options.filter_pack;b.load_filter_pack.resolve(b.filter_pack);b.load_fonts()}});b.load_sticker_pack=$.Deferred();$.ajax({url:b.options.sticker_pack+"sticker-pack.json",success:function(a){b.sticker_pack=a.sticker_pack;b.sticker_pack.by_slug={};b.sticker_pack.base_path=b.options.sticker_pack;$.each(b.sticker_pack.sections,function(a,c){$.each(c.stickers,function(a,
c){b.sticker_pack.by_slug[c.slug]=c})});b.load_sticker_pack.resolve(b.sticker_pack)}});b.current_filter="_original";b.filter_specs={_original:{name:"*Original*",slug:"_original",layers:[]}};b.stickers=[];b.text=[]};SnaprFX.prototype.set_url=function(c,b){var a=this;this.options.url=c;var d=$.Deferred();SnaprFX.utils.read_exif(a.options.url).done(function(b){a.exif=b;a.load_original(!0).done(function(){a.apply_filter({editable:a.render_options.editable});d.resolve()})});return d};
SnaprFX.prototype.set_options=function(c){var b=this.options.render_text;$.extend(this.options,c);!b&&this.options.render_text&&this.apply_filter({render_text:!0,editable:!1});this.elements.overlay.toggleClass("fx-text-disabled",!0===this.options.disable_text_edit);this.elements.overlay.toggleClass("fx-stickers-disabled",!0===this.options.disable_sticker_edit)};
SnaprFX.prototype.load_fonts=function(){var c=this;$.each(c.filter_pack.sections,function(b,a){$.each(a.filters,function(a,b){var g=c.filter_pack.base_path+"filters/"+b.slug+"/";$.ajax({url:g+"filter.json",success:function(a){c.filter_specs[b.slug]=a.filter;a.filter.fonts&&$.each(a.filter.fonts,function(a,b){var c;c="@font-face {"+("font-family: '"+b["font-family"]+"';");b["font-weight"]&&(c+="font-weight: "+b["font-weight"]+";");b["font-style"]&&(c+="font-style: "+b["font-style"]+";");b.eot&&(c+=
"src: url('"+g+"fonts/"+b.eot+"');");c+="src:";b.eot&&(c+="url('"+g+"fonts/"+b.eot+"?#iefix') format('embedded-opentype'),");b.woff&&(c+="url('"+g+"fonts/"+b.woff+"') format('woff'),");b.ttf&&(c+="url('"+g+"fonts/"+b.ttf+"') format('truetype'),");b.svg&&(c+="url('"+g+"fonts/"+b.svg+"#"+b["font-family"]+"') format('svg');");$("<style>"+(c+"}")+"</style>").appendTo(document.head);$('<span style="font-family: '+b["font-family"]+'"></span>').appendTo(document.body)})}})})})};
SnaprFX.prototype.load_original=function(c){var b=this,a=$.Deferred();b.original=new SnaprFX.Canvas({url:b.options.url,size:b.options.size,aspect:b.options.aspect,width:b.options.width,height:b.options.height,orientation:b.exif&&b.exif.orientation});b.original.deferred.done(function(){!1===c?a.resolve():b.render_stickers().done(function(){a.resolve()})});return a};SnaprFX.prototype.update_element=function(){this.options.element.attr("src",this.canvas.get_data_url())};
SnaprFX.prototype.apply_filter=function(c){var b=this;b.deferred=$.Deferred();$(document.body).addClass("fx-processing");setTimeout(function(){function a(){var a=b.filter_specs[b.current_filter];a&&(a.layer_index=-1);if(b.render_options.region)debug_logging&&console.log("region",b.render_options.region),a=b.render_options.region,b.canvas.context.drawImage(b.original.canvas,a.left,a.top,a.width,a.height,a.left,a.top,a.width,a.height);else{var f=!1,a=function(){f&&b.canvas.context.drawImage(b.original.canvas,
0,0);f=!0};b.canvas.set_size(b.render_options.width,b.render_options.height).done(a);b.original.set_size(b.render_options.width,b.render_options.height).done(a)}a=function(){b.pixels=b.canvas.get_data();b.apply_next_layer()};!c.editable||b.options.disable_sticker_edit?b.render_stickers().done(a):a()}c=$.extend({filter:b.current_filter,editable:!1,width:b.options.width,height:b.options.height},c);b.render_options=c;!c.editable&&!c.output&&b.deferred.done(function(){(!1!==b.options.render_text||b.render_options.render_text)&&
$.each(b.text,function(a,b){b.rerender()});$.each(b.stickers,function(a,b){b.rerender()})});c.filter!=b.current_filter&&(b.elements.overlay.find(".fx-text").addClass("fx-text-old"),b.without_extras=null);debug_logging&&console.group(c.filter);(b.current_filter=c.filter)?c.filter in b.filter_specs?setTimeout(a,4):$.ajax({url:b.filter_pack.base_path+"filters/"+c.filter+"/filter.json",success:function(d){debug_logging&&console.log("loaded",c.filter);b.filter_specs[c.filter]=d.filter;setTimeout(a,4)}}):
setTimeout(a,4)},4)};SnaprFX.prototype.output=function(c){var b=this,a=$.Deferred();b.apply_filter({output:!0,width:c.width,height:c.height});b.deferred.done(function(){a.resolve(b.canvas.get_data_url())});return a};
SnaprFX.prototype.apply_next_layer=function(){var c=this,b=c.filter_specs[c.current_filter];b.layer_index++;if(b.layer_index>=b.layers.length)c.finish();else{debug_logging&&console.time("applying "+b.layers[b.layer_index].type+" layer");debug_logging&&console.log("applying",b.layers[b.layer_index].type,"layer");var a=b.layers[b.layer_index];a.filter?a.filter.update&&a.filter.update(a,c):a.filter=new SnaprFX.filters[a.type](a,c);a.blender=a.blender||new SnaprFX.Blender(a.blending_mode||"normal");a.filter.deferred.done(function(){function d(){for(var d=
c.render_options.region||{left:0,top:0,width:c.canvas.width,height:c.canvas.height},h,k=d.top;k<d.top+d.height;k+=1)for(var n=d.left;n<d.left+d.width;n+=1){h=4*(k*c.canvas.width+n);var m;m=a.filter.whole_canvas?[f.data[h],f.data[h+1],f.data[h+2],f.data[h+3]]:a.filter.process(h,[c.pixels.data[h],c.pixels.data[h+1],c.pixels.data[h+2]]);var p=m[O],p=0<=p?p/255:1;a.mask_image&&(p*=g.data[h]/255);p*=a.opacity/100;m=a.blender.process([c.pixels.data[h],c.pixels.data[h+1],c.pixels.data[h+2]],[m[R],m[G],m[B]],
p);c.pixels.data[h]=m[R];c.pixels.data[h+1]=m[G];c.pixels.data[h+2]=m[B]}debug_logging&&console.timeEnd("applying "+b.layers[b.layer_index].type+" layer");c.apply_next_layer()}var f;a.filter.whole_canvas&&(0!==b.layer_index&&c.canvas.put_data(c.pixels),a.filter.process(c.canvas),f=c.canvas.get_data());var g;if(a.mask_image){var h=new SnaprFX.Canvas({url:c.filter_pack.base_path+"filters/"+b.slug+"/"+a.mask_image,width:c.canvas.width,height:c.canvas.height});h.deferred.done(function(){g=h.get_data();
d()})}else d()})}};
SnaprFX.prototype.finish=function(){debug_logging&&console.time("writing data back");this.elements.overlay.find(".fx-text-old").remove();this.canvas.put_data(this.pixels);this.render_options.output||this.update_element();this.deferred.resolve();$(document.body).removeClass("fx-processing");if(!1===this.options.render_text&&!this.render_options.render_text&&!this.render_options.output||this.render_options.editable&&!this.options.disable_text_edit)this.without_extras=this.canvas.clone();debug_logging&&
console.timeEnd("writing data back");debug_logging&&console.groupEnd(this.current_filter)};SnaprFX.prototype.unrender_editables=function(){this.options.disable_sticker_edit||$.each(this.stickers,function(c,b){b.unrender()});this.options.disable_text_edit||$.each(this.text,function(c,b){b.unrender()});this.without_extras?(this.canvas.context.drawImage(this.without_extras.canvas,0,0),this.update_element()):this.apply_filter({editable:!0})};SnaprFX.prototype.rerender_editables=function(){this.apply_filter({editable:!1})};
SnaprFX.prototype.create_overlay_elements=function(){var c=this;c.elements={image:c.options.element};c.elements.overlay=$('<div class="fx-overlay-layer">').css({position:"absolute",top:0,left:0,height:"100%",width:"100%"}).click(function(b){$(b.target).closest(".fx-text-wrapper").length||(c.render_options.editable&&!$(b.target).closest(".fx-sticker").length&&c.rerender_editables(),c.active_text&&c.active_text.deactivate())});c.elements.wrapper=$('<div class="fx-wrapper">').css({position:"relative",
height:c.options.height,width:c.options.width});c.elements.wrapper.insertAfter(c.elements.image);c.elements.image.appendTo(c.elements.wrapper);c.elements.overlay.appendTo(c.elements.wrapper);c.elements.overlay.offset_cache=c.elements.overlay.offset()};"function"===typeof define&&define.amd&&define(function(){return SnaprFX});SnaprFX.utils={compatible:function(){var c=document.createElement("canvas");return!(!c.getContext||!c.getContext("2d"))},rotated_dimensions:function(c,b,a){var d=Math.abs(Math.cos(a)*c)+Math.abs(Math.sin(a)*b);c=Math.abs(Math.sin(a)*c)+Math.abs(Math.cos(a)*b);return{width:d,height:c}},cart2polar:function(c,b){var a=Math.atan(b/c);0<b?0>c&&(a=Math.PI+a):a=0>c?Math.PI+a:2*Math.PI+a;return a},pythag:function(c,b){return Math.sqrt(Math.pow(c,2)+Math.pow(b,2))},preload_assets:function(c){$.ajax({url:c.filter_pack+
"filter-pack.json",success:function(b){$.each(b.filter_pack.sections,function(a,b){$.each(b.filters,function(a,b){var d=c.filter_pack+"filters/"+b.slug+"/";$.ajax({url:d+"filter.json",success:function(a){a.filter.fonts&&$.each(a.filter.fonts,function(a,b){var c;c="@font-face {"+("font-family: '"+b["font-family"]+"';");b["font-weight"]&&(c+="font-weight: "+b["font-weight"]+";");b["font-style"]&&(c+="font-style: "+b["font-style"]+";");b.eot&&(c+="src: url('"+d+"fonts/"+b.eot+"');");c+="src:";b.eot&&
(c+="url('"+d+"fonts/"+b.eot+"?#iefix') format('embedded-opentype'),");b.woff&&(c+="url('"+d+"fonts/"+b.woff+"') format('woff'),");b.ttf&&(c+="url('"+d+"fonts/"+b.ttf+"') format('truetype'),");b.svg&&(c+="url('"+d+"fonts/"+b.svg+"#"+b["font-family"]+"') format('svg');");$("<style>"+(c+"}")+"</style>").appendTo(document.head);$('<span style="font-family: '+b["font-family"]+'"></span>').appendTo(document.body)});$.each(a.filter.layers,function(a,b){"image"==b.type&&((new Image).src=d+b.image.image)})}})})})}});
$.ajax({url:c.sticker_pack+"sticker-pack.json",success:function(b){$.each(b.sticker_pack.sections,function(a,b){$.each(b.stickers,function(a,b){(new Image).src=c.sticker_pack+"assets/"+b.slug+".png"})})}})},read_exif:function(c){var b=$.Deferred(),a=new XMLHttpRequest;a.open("GET",c,!0);a.responseType="arraybuffer";a.onload=function(c){var f=new FileReader;f.onloadend=function(){var c=new JpegMeta.JpegFile(this.result,"test.jpg");a=f=null;b.resolve({latitude:c.gps&&c.gps.latitude&&c.gps.latitude.value,
longitude:c.gps&&c.gps.longitude&&c.gps.longitude.value,date:c.exif&&c.exif.DateTimeOriginal&&c.exif.DateTimeOriginal.value,orientation:c.tiff&&c.tiff.Orientation&&c.tiff.Orientation.value})};c=new Blob([this.response]);f.readAsBinaryString(c)};a.send();return b},rgbToHsl:function(c,b,a){c/=255;b/=255;a/=255;var d=Math.max(c,b,a),f=Math.min(c,b,a),g,h=(d+f)/2;if(d==f)g=f=0;else{var e=d-f,f=0.5<h?e/(2-d-f):e/(d+f);switch(d){case c:g=(b-a)/e+(b<a?6:0);break;case b:g=(a-c)/e+2;break;case a:g=(c-b)/e+
4}g/=6}return[g,f,h]},hslToRgb:function(c,b,a){if(0===b)a=b=c=a;else{var d=0.5>a?a*(1+b):a+b-a*b,f=2*a-d;a=SnaprFX.utils.hueToRgb(f,d,c+1/3);b=SnaprFX.utils.hueToRgb(f,d,c);c=SnaprFX.utils.hueToRgb(f,d,c-1/3)}return[255*a,255*b,255*c]},hueToRgb:function(c,b,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?c+6*(b-c)*a:0.5>a?b:a<2/3?c+6*(b-c)*(2/3-a):c}};SnaprFX.prototype.add_sticker=function(c){var b=this,a=new SnaprFX.sticker(c,b);b.stickers.push(a);a.deferred.done(function(){b.elements.overlay.append(a.element);a.element.addClass("fx-active").siblings(".fx-active").removeClass("fx-active")});b.render_options.editable=!0};
SnaprFX.prototype.render_stickers=function(){function c(){var c=!0;$.each(b.stickers,function(a,b){if("pending"==b.deferred.state())return c=!1});c&&a.resolve()}var b=this,a=$.Deferred();b.original.deferred.done(function(){b.stickers.length||a.resolve();$.each(b.stickers,function(a){b.stickers[a].render(b.canvas).done(c)})});return a};
SnaprFX.sticker=function(c,b){var a=this;a.slug=c;a.parent=b;a.scale=1;a.rotation=0;a.spec=b.sticker_pack.by_slug[c];a.deferred=$.Deferred();a.load().done(function(){a.scale_factor=Math.min(b.canvas.width/b.sticker_pack.target_canvas.width,b.canvas.height/b.sticker_pack.target_canvas.height);var d;d='<div class="fx-sticker fx-sticker-rendered"><a class="fx-remove-sticker fx-sticker-handle" data-role="button" data-icon="delete" data-iconpos="notext" data-theme="e">\u2717</a><a class="fx-render-sticker fx-sticker-handle" data-role="button" data-icon="tick" data-iconpos="notext" data-theme="e">\u2714</a>';
d+='<a class="fx-scale-sticker fx-sticker-handle" data-role="button" data-icon="rotate" data-iconpos="notext" data-theme="e"> </a>';d+='<img class="fx-sticker-image" src="'+a.parent.sticker_pack.base_path+"assets/"+c+'.png">';d+="</div>";var f={position:"absolute",width:a.image.width*a.scale_factor,height:a.image.height*a.scale_factor};a.spec.position&&a.spec.position.center?(f.left=a.spec.position.center.x*a.scale_factor-f.width/2,f.top=a.spec.position.center.y*a.scale_factor-f.height/2):(f.left=
b.canvas.width/2-f.width/2,f.top=b.canvas.height/2-f.height/2);a.element=$(d).css(f);a.initial=f;a.rendered||a.element.removeClass("fx-sticker-rendered");a.element.find(".fx-render-sticker").on("click",function(a){b.rerender_editables();a.stopPropagation()});a.element.find(".fx-remove-sticker").on("click",function(){a.remove()});a.element.on("mousedown",function(){a.parent.options.disable_sticker_edit||(a.rendered&&b.unrender_editables(),a.element.addClass("fx-active").removeClass("fx-sticker-rendered").siblings(".fx-active").removeClass("fx-active"))});
a.mousemove_drag=function(b){a.rendered||a.element.css({left:b.pageX-a.drag_from.left,top:b.pageY-a.drag_from.top})};a.mouseup=function(){b.elements.wrapper.off("mousemove",a.mousemove_drag);b.elements.wrapper.off("mousemove",a.mousemove_scale)};b.elements.wrapper.on("mouseup",a.mouseup);a.element.on("mousedown",function(c){if(!a.rendered){var d=parseInt(a.element.css("left"),10),f=parseInt(a.element.css("top"),10);a.drag_from={left:c.pageX-d,top:c.pageY-f,event:c};b.elements.wrapper.on("mousemove",
a.mousemove_drag)}b.elements.overlay.addClass("fx-editing-sticker").removeClass("fx-editing-text")});a.mousemove_scale=function(b){b.stopPropagation();if(!a.rendered){var c=SnaprFX.utils.pythag(b.pageX-a.scale_from.x,b.pageY-a.scale_from.y);a.scale=c/a.scale_from.size;a.scale=Math.max(a.scale,0.15);b=SnaprFX.utils.cart2polar(b.pageX-a.scale_from.x,b.pageY-a.scale_from.y);a.rotation=-a.scale_from.rotation+b;b=a.initial.width*a.scale;c=a.initial.height*a.scale;a.element.css({transform:"rotate("+360*
(a.rotation/(2*Math.PI))+"deg)",width:b,height:c,top:a.scale_from.y-c/2-a.parent.elements.overlay.offset_cache.top,left:a.scale_from.x-b/2-a.parent.elements.overlay.offset_cache.left})}};a.element.find(".fx-scale-sticker").on("mousedown",function(c){c.stopPropagation();window.element=a.element;if(!a.rendered){var d=a.get_dimensions(),f=a.element.find(".fx-sticker-image").offset();a.scale_from={x:f.left+d.width/2,y:f.top+d.height/2,size:SnaprFX.utils.pythag(a.element.height(),a.element.width())/2/
a.scale,scale:a.scale};a.scale_from.rotation=SnaprFX.utils.cart2polar(c.pageX-a.scale_from.x,c.pageY-a.scale_from.y)-a.rotation;b.elements.wrapper.on("mousemove",a.mousemove_scale)}});a.element.on("dragstart",function(a){a.preventDefault()});a.deferred.resolve()})};
SnaprFX.sticker.prototype.load=function(){var c=this;if(c.load_deferred)return c.load_deferred;c.load_deferred=$.Deferred();c.image=new Image;c.image.src=c.parent.sticker_pack.base_path+"assets/"+c.slug+".png";c.image.onload=function(){c.load_deferred.resolve()};return c.load_deferred};
SnaprFX.sticker.prototype.render=function(c){var b=this;b.deferred=$.Deferred();var a=b.element.find(".fx-sticker-image"),d=a.offset(),f=b.element.parent(),g=f.offset(),h=(d.left-g.left)/f.width(),e=(d.top-g.top)/f.height(),l=a.width()/f.width()*c.width,k=a.height()/f.height()*c.height,a=b.rotation,d=Math.PI;a>2*d&&(a-=2*d);0>a&&(a+=2*d);f=Math.sin(a);g=Math.cos(a);a<d/2?h+=f*k/c.width:a>1.5*d?e+=-f*l/c.height:a>d/2&&a<d?(h+=(f*k+-g*l)/c.width,e+=-g*k/c.height):(h+=-g*l/c.width,e+=(-g*k-f*l)/c.height);
b.load().done(function(){c.context.translate(h*c.width,e*c.height);c.context.rotate(b.rotation);c.context.drawImage(b.image,0,0,b.image.width,b.image.height,0,0,l,k);c.context.rotate(-b.rotation);c.context.translate(-h*c.width,-e*c.height);b.deferred.resolve()});return b.deferred};SnaprFX.sticker.prototype.unrender=function(){this.rendered=!1;this.element.removeClass("fx-sticker-rendered")};SnaprFX.sticker.prototype.rerender=function(){this.rendered=!0;this.element.addClass("fx-sticker-rendered")};
SnaprFX.sticker.prototype.remove=function(){var c=this;c.element.remove();c.parent.elements.wrapper.off("mousemove",c.mousemove).off("mouseup",c.mouseup);$.each(c.parent.stickers,function(b,a){a==c&&c.parent.stickers.splice(b,1)})};SnaprFX.sticker.prototype.get_dimensions=function(){return SnaprFX.utils.rotated_dimensions(this.element.width(),this.element.height(),-this.rotation)};SnaprFX.Canvas=function(c){var b=this;debug_logging&&console.log("canvas",c);b.options=c;b.deferred=$.Deferred();b.canvas=document.createElement("canvas");b.context=b.canvas.getContext("2d");debug_canvas&&($(document.body).append(b.canvas),$(b.canvas).css({border:"1px solid #f00",width:200}));if(c.url){debug_logging&&console.time("get image");switch(c.orientation){case 3:b.options.rotation=Math.PI;break;case 6:b.options.rotation=0.5*Math.PI;break;case 8:b.options.rotation=1.5*Math.PI;break;default:b.options.rotation=
0}b.image=new Image;b.image.src=c.url;b.image.onload=function(){b.place_image().done(function(){b.deferred.resolve()})}}else b.width=b.canvas.width=c.width,b.height=b.canvas.height=c.height,b.deferred.resolve()};
SnaprFX.Canvas.prototype.place_image=function(){var c=$.Deferred();this.image.aspect=this.image.width/this.image.height;var b=0,a=0,d=this.image.width,f=this.image.height;if(this.options.size)if(this.options.aspect){var g;this.image.aspect>this.options.aspect?(this.height=this.canvas.height=this.options.size,this.width=this.canvas.width=this.height*this.options.aspect,g=this.image.width-this.image.height*this.options.aspect,b=g/2,d=this.image.width-g):(this.width=this.canvas.width=this.options.size,
this.height=this.canvas.height=this.width/this.options.aspect,g=this.image.height-this.image.width/this.options.aspect,a=g/2,f=this.image.height-g)}else 1<this.image.aspect?(this.width=this.canvas.width=this.options.size,this.height=this.canvas.height=this.width/this.image.aspect):(this.height=this.canvas.height=this.options.size,this.width=this.canvas.width=this.height*this.image.aspect);else this.width=this.canvas.width=this.options.width||this.image.width,this.height=this.canvas.height=this.options.height||
this.image.height;this.context.translate(this.canvas.width/2,this.canvas.height/2);this.context.rotate(this.options.rotation);this.context.drawImage(this.image,b,a,d,f,this.canvas.width/-2,this.canvas.height/-2,this.canvas.width,this.canvas.height);this.context.rotate(-this.options.rotation);this.context.translate(this.canvas.width/-2,this.canvas.height/-2);c.resolve();debug_logging&&console.timeEnd("get image");return c};
SnaprFX.Canvas.prototype.get_data=function(){return this.context.getImageData(0,0,this.canvas.width,this.canvas.height)};SnaprFX.Canvas.prototype.put_data=function(c){this.context.putImageData(c,0,0);return this};SnaprFX.Canvas.prototype.get_data_url=function(){return this.canvas.toDataURL("image/jpeg",1)};SnaprFX.Canvas.prototype.clear=function(){this.canvas.width=this.canvas.width};
SnaprFX.Canvas.prototype.set_size=function(c,b){this.canvas.width!=c&&(this.width=c,this.options.width=c,this.canvas.width=c);this.canvas.height!=b&&(this.height=b,this.options.height=b,this.canvas.height=b);return this.image?this.place_image():$.Deferred().resolve()};SnaprFX.Canvas.prototype.clone=function(c){c=new SnaprFX.Canvas($.extend({},this.options,c));c.context.drawImage(this.canvas,0,0);return c};SnaprFX.Blender=function(c){debug_logging&&console.log(" - Blend:",c);this.mode=this.blend_modes[c];this.process=this.mode.rgb?function(b,a,c){a=this.mode.process(b,a);for(var f=[],g=R;g<=B;g++)f[g]=a[g]*c+b[g]*(1-c);return f}:function(b,a,c){for(var f=[],g=R;g<=B;g++)f[g]=this.mode.process(b[g],a[g]),f[g]=f[g]*c+b[g]*(1-c);return f}};
SnaprFX.Blender.prototype.blend_modes={normal:{rgb:!1,process:function(c,b,a){return b}},multiply:{rgb:!1,process:function(c,b,a){return c*b/255}},screen:{rgb:!1,process:function(c,b,a){return 255-((255-b)*(255-c)>>8)}},overlay:{rgb:!1,process:function(c,b,a){return 128>c?c*b*(2/255):255-(255-c)*(255-b)*(2/255)}},darken:{rgb:!1,process:function(c,b,a){c<b&&(b=c);return b}},lighten:{rgb:!1,process:function(c,b,a){c>b&&(b=c);return b}},color_dodge:{rgb:!1,process:function(c,b,a){c=(c<<8)/(255-b);return 255<
c||255==b?255:c}},color_burn:{rgb:!1,process:function(c,b,a){c=255-(255-c<<8)/b;return 0>c||0===b?0:c}},soft_light:{rgb:!1,process:function(c,b,a){return 128>c?((b>>1)+64)*c*(2/255):255-(191-(b>>1))*(255-c)*(2/255)}},hard_light:{rgb:!1,process:function(c,b,a){return 128>b?c*b*(2/255):255-(255-c)*(255-b)*(2/255)}},difference:{rgb:!1,process:function(c,b,a){c-=b;return 0>c?-c:c}},exclusion:{rgb:!1,process:function(c,b,a){return c-(c*(2/255)-1)*b}},hue:{rgb:!0,process:function(c,b,a){return b}},saturation:{rgb:!0,
process:function(c,b,a){return b}},color:{rgb:!0,process:function(c,b,a){c=SnaprFX.utils.rgbToHsl(c[0],c[1],c[2]);b=SnaprFX.utils.rgbToHsl(b[0],b[1],b[2]);return SnaprFX.utils.hslToRgb(b[0],b[1],c[2])}},luminosity:{rgb:!0,process:function(c,b,a){return b}},subtract:{rgb:!1,process:function(c,b,a){b=c-b;0>b&&(b=0);return b}},add:{rgb:!1,process:function(c,b,a){b=c+b;255<b&&(b=255);return b}},divide:{rgb:!1,process:function(c,b,a){return 255*(c/b)}},linear_burn:{rgb:!1,process:function(c,b,a){return 255>
c+b?0:c+b-255}}};SnaprFX.filters={};SnaprFX.filters.adjustment=function(c){debug_logging&&console.log(" - Adjustment:",c.adjustment.type);this.filter=new SnaprFX.filters[c.adjustment.type](c);this.whole_canvas=this.filter.whole_canvas;this.process=this.filter.process;this.deferred=$.Deferred().resolve()};
SnaprFX.filters.curves=function(c){this.curves=c.adjustment;this.splines={};var b=this;$.each(["rgb","red","green","blue"],function(a,c){if(0===b.curves[c].length)b.splines[c]={interpolate:function(a){return a}};else{var f=[],g=[];$.each(b.curves[c],function(a,b){f.push(b[0]);g.push(b[1])});b.splines[c]=new b.CubicSpline(f,g)}})};
SnaprFX.filters.curves.prototype.process=function(c,b){b[0]=this.filter.splines.red.interpolate(b[0]);b[1]=this.filter.splines.green.interpolate(b[1]);b[2]=this.filter.splines.blue.interpolate(b[2]);b[0]=this.filter.splines.rgb.interpolate(b[0]);b[1]=this.filter.splines.rgb.interpolate(b[1]);b[2]=this.filter.splines.rgb.interpolate(b[2]);return b};
SnaprFX.filters.curves.prototype.CubicSpline=function(){function c(b,a){var c,f,g,h,e,l,k,n,m,p;if(null!==b&&null!==a){k=b.length-1;h=[];m=[];l=[];n=[];p=[];f=[];c=[];g=[];this.max_out=a[0];this.min_out=a[0];this.max_in=b[0];this.min_in=b[0];for(e=0;0<=k?e<k:e>k;0<=k?e+=1:e-=1)h[e]=b[e+1]-b[e],this.max_out=a[e+1]>this.max_out?a[e+1]:this.max_out,this.min_out=a[e+1]<this.min_out?a[e+1]:this.min_out,this.max_in=b[e+1]>this.max_in?b[e+1]:this.max_in,this.min_in=b[e+1]<this.min_in?b[e+1]:this.min_in;
for(e=1;1<=k?e<k:e>k;1<=k?e+=1:e-=1)m[e]=3/h[e]*(a[e+1]-a[e])-3/h[e-1]*(a[e]-a[e-1]);l[0]=1;n[0]=0;p[0]=0;for(e=1;1<=k?e<k:e>k;1<=k?e+=1:e-=1)l[e]=2*(b[e+1]-b[e-1])-h[e-1]*n[e-1],n[e]=h[e]/l[e],p[e]=(m[e]-h[e-1]*p[e-1])/l[e];l[k]=1;p[k]=0;f[k]=0;for(e=l=k-1;0>=l?0>=e:0<=e;0>=l?e+=1:e-=1)f[e]=p[e]-n[e]*f[e+1],c[e]=(a[e+1]-a[e])/h[e]-h[e]*(f[e+1]+2*f[e])/3,g[e]=(f[e+1]-f[e])/(3*h[e]);this.x=b.slice(0,k+1);this.a=a.slice(0,k);this.b=c;this.c=f.slice(0,k);this.d=g}}c.prototype.derivative=function(){var b,
a,c,f,g;a=new this.constructor;a.x=this.x.slice(0,this.x.length);a.a=this.b.slice(0,this.b.length);g=this.c;c=0;for(f=g.length;c<f;c++)b=g[c],a.b=2*b;g=this.d;c=0;for(f=g.length;c<f;c++)b=g[c],a.c=3*b;b=0;for(c=this.d.length;0<=c?b<c:b>c;0<=c?b+=1:b-=1)a.d=0;return a};c.prototype.interpolate=function(b){if(b>=this.max_in)return this.max_out;if(b<=this.min_in)return this.min_out;var a,c;for(a=c=this.x.length-1;(0>=c?0>=a:0<=a)&&!(this.x[a]<=b);0>=c?a+=1:a-=1);b-=this.x[a];return this.a[a]+this.b[a]*
b+this.c[a]*Math.pow(b,2)+this.d[a]*Math.pow(b,3)};return c}();SnaprFX.filters.levels=function(c){var b=c.adjustment;this.interpolate=function(a){var c=b.white-b.black;return Math.pow((a-b.black)/c,1/b.mid)*c/(c/255)}};SnaprFX.filters.levels.prototype.process=function(c,b){b[R]=this.filter.interpolate(b[R]);b[G]=this.filter.interpolate(b[G]);b[B]=this.filter.interpolate(b[B]);return b};SnaprFX.filters.hue=function(c){this.hue=c.adjustment.amount};
SnaprFX.filters.hue.prototype.process=function(c,b){var a=SnaprFX.utils.rgbToHsl(b[R],b[G],b[B]);a[0]+=this.filter.hue/255;1<a[0]&&(a[0]-=1);0>a[0]&&(a[0]+=1);return SnaprFX.utils.hslToRgb(a[0],a[1],a[2])};SnaprFX.filters.saturation=function(c){this.saturation=c.adjustment.amount/100};
SnaprFX.filters.saturation.prototype.process=function(c,b){var a=SnaprFX.utils.rgbToHsl(b[R],b[G],b[B]),d;d=0>this.filter.saturation?a[1]*(this.filter.saturation+1):a[1]*(2*this.filter.saturation+1);d=Math.min(255,d);return SnaprFX.utils.hslToRgb(a[0],d,a[2])};SnaprFX.filters.lightness=function(c){this.lightness=c.adjustment.amount/100};
SnaprFX.filters.lightness.prototype.process=function(c,b){var a=this.filter.lightness,d=0>a?1+a:1-a,a=0>a?0:255*a;return[Math.min(b[R]*d+a,255),Math.min(b[G]*d+a,255),Math.min(b[B]*d+a,255)]};SnaprFX.filters.blur=function(c){this.whole_canvas=!0;this.amount=Math.max(0,Math.min(5,c.adjustment.amount))};
SnaprFX.filters.blur.prototype.process=function(c){var b=Math.round(c.width/2),a=Math.round(c.height/2),d=document.createElement("canvas");d.width=b;d.height=a;for(var f=Math.round(20*this.filter.amount),g=d.getContext("2d"),h=0;h<f;h++){var e=Math.max(1,Math.round(b-h)),l=Math.max(1,Math.round(a-h));g.clearRect(0,0,b,a);g.drawImage(c.canvas,0,0,c.width,c.height,0,0,e,l);c.context.drawImage(d,0,0,e,l,0,0,c.width,c.height)}};SnaprFX.filters.color=function(c){this.color=c.color.rgb;this.deferred=$.Deferred().resolve()};
SnaprFX.filters.color.prototype.process=function(c,b){return this.color};SnaprFX.filters.image=function(c,b){var a=this;a.url=c.image.image;a.width=b.canvas.width;a.height=b.canvas.height;a.canvas=new SnaprFX.Canvas({url:b.filter_pack.base_path+"filters/"+b.current_filter+"/"+a.url,width:a.width,height:a.height});a.deferred=$.Deferred();a.canvas.deferred.done(function(){a.pixels=a.canvas.get_data();a.deferred.resolve()})};
SnaprFX.filters.image.prototype.update=function(c,b){var a=this;a.width=b.canvas.width;a.height=b.canvas.height;a.deferred=$.Deferred();a.canvas.set_size(a.width,a.height).done(function(){a.pixels=a.canvas.get_data();a.deferred.resolve()})};SnaprFX.filters.image.prototype.process=function(c,b){return[this.pixels.data[c],this.pixels.data[c+1],this.pixels.data[c+2],this.pixels.data[c+3]]};var debug_borders=!1;SnaprFX.prototype.add_text=function(c){c.filter=new SnaprFX.filters.text(c,this);this.filter_specs[this.current_filter].layers.push(c)};SnaprFX.filters.text=function(c,b){b.text.push(this);this.slug=c.slug;this.text_style=c.text.style;this.text=b.options.text&&b.options.text[c.slug]||c.text.default_value;this.canvas=new SnaprFX.Canvas({width:b.canvas.width,height:b.canvas.height});this.update(c,b)};
SnaprFX.filters.text.prototype.calculate_position=function(c,b){b.filter_specs[b.current_filter].target_canvas?(this.x_scale_factor=this.canvas.width/b.filter_specs[b.current_filter].target_canvas.width,this.y_scale_factor=this.canvas.height/b.filter_specs[b.current_filter].target_canvas.height):this.x_scale_factor=this.y_scale_factor=1;this.position=c.position&&c.position.bbox?{top:c.position.bbox.top*this.y_scale_factor,bottom:c.position.bbox.bottom*this.y_scale_factor,left:c.position.bbox.left*
this.x_scale_factor,right:c.position.bbox.right*this.x_scale_factor}:{top:0,bottom:this.canvas.height,left:0,right:this.canvas.width};c.position&&(this.position.x=c.position.x*this.x_scale_factor,this.position.y=c.position.y*this.y_scale_factor);this.bbox={top:this.position.top,bottom:this.position.bottom,left:this.position.left,right:this.position.right}};
SnaprFX.filters.text.prototype.set_canvas_font=function(){this.text_element.css("font-size",parseInt(this.text_element.css("font-size"),10)*this.render_scale);this.text_element.css("line-height",parseInt(this.text_element.css("line-height"),10)*this.render_scale+"px");this.canvas.context.font=this.text_element.css("font");this.text_element.css("font-size",parseInt(this.text_element.css("font-size"),10)/this.render_scale);this.text_element.css("line-height",parseInt(this.text_element.css("line-height"),
10)/this.render_scale+"px")};
SnaprFX.filters.text.prototype.update=function(c,b){function a(a,b){for(var c=a.split("\n"),f=[],g=0,e=0;e<c.length;e++){var h=c[e].split(" ");f[g]=h[0];for(var l=1;l<h.length;l++)d.canvas.context.measureText(f[g]+" "+h[l]).width>b?(g++,f[g]=h[l]):f[g]=f[g]+" "+h[l];g++}return f}var d=this;d.rendered=(!1!==b.options.render_text||b.render_options.render_text||b.render_options.output)&&(!b.render_options.editable||b.options.disable_text_edit);d.spec=c;d.dragable=c.position&&c.position.dragable;d.deferred=
$.Deferred();d.canvas.set_size(b.canvas.width,b.canvas.height);d.canvas.clear();d.calculate_position(c,b);d.create_overlay(c,b);d.text=d.text_element.html().replace(/<br\/?>/g,"\n").replace(/&nbsp;/g," ").replace(/<.*?>/g,"");d.text_element.html(d.text.replace(/\n/g,"<br>"));d.text_style.fillStyle=d.text_element.css("color");d.text_style.textAlign=d.element.css("text-align");d.render_scale=d.canvas.height/b.elements.overlay.height();d.set_canvas_font();d.canvas.context.textAlign=d.text_style.textAlign||
"left";d.canvas.context.textBaseline=d.text_style.textBaseline||"top";d.canvas.context.fillStyle=d.text_style.fillStyle;d.text_style.fontSize=parseInt(d.text_element.css("font-size"),10);d.text_style.lineHeight=parseInt(d.text_element.css("line-height"),10);var f=d.element.position();d.position.left=f.left;d.position.top=f.top;d.position.right=f.left+d.element.width();d.position.bottom=f.top+d.element.height();for(var f=d.position.right-d.position.left,g=Math.round(d.position.bottom-d.position.top),
h=a(d.text,f),e=1E3;e&&(!h||(h.length-1)*d.text_style.lineHeight+d.text_style.fontSize>g);)e--,d.text_style.fontSize*=0.8,d.text_element.css("font-size",d.text_style.fontSize),d.text_style.lineHeight*=0.8,d.text_element.css("line-height",d.text_style.lineHeight+"px"),d.set_canvas_font(),h=a(d.text,f);e||console.warn("render shrunk text 1000 times without success!");switch(d.text_style.textAlign){case "end":case "right":e=d.position.right;break;case "center":e=f/2+d.position.left;break;default:e=d.position.left}e*=
d.render_scale;switch(d.text_style.textBaseline){case "hanging":case "alphabetic":case "ideographic":case "bottom":g=d.position.bottom-d.text_style.lineHeight*(h.length-1);break;case "middle":g=g/2+d.position.top-d.text_style.lineHeight*(h.length-1)/2;break;default:g=d.position.top}g*=d.render_scale;if(d.slug!==b.render_options.active_text&&!c.removed)for(var l=0;l<h.length;l++)debug_borders&&d.canvas.context.strokeRect(d.position.left*d.x_scale_factor*d.render_scale,g+l*d.text_style.lineHeight*d.render_scale,
f*d.render_scale,d.text_style.lineHeight*d.render_scale),d.canvas.context.fillText(h[l],e,g+l*d.text_style.lineHeight*d.render_scale,f);d.pixels=d.canvas.get_data();d.deferred.resolve()};
SnaprFX.filters.text.prototype.create_overlay=function(c,b){var a=this;if(!a.element||!jQuery.contains(document.documentElement,a.element[0])){a.overlay=b.elements.overlay;var d={position:"absolute",left:a.position.left,top:a.position.top,width:a.position.right-a.position.left,height:a.position.bottom-a.position.top,"text-align":a.text_style.textAlign};if(a.position.x)switch(a.text_style.textAlign){case "end":case "right":d.width=a.position.x;break;case "center":a.position.right-a.position.x<a.position.x-
a.position.left?(d.width=2*(a.position.right-a.position.x),d.left=a.position.right-d.width):d.width=2*(a.position.x-a.position.left);break;default:d.left=a.position.x,d.width=a.position.right-a.position.x}if(a.position.y)switch(a.text_style.textBaseline){case "hanging":case "alphabetic":case "ideographic":case "bottom":d.height=a.position.y;break;case "middle":a.position.bottom-a.position.y<a.position.y-a.position.top?(d.height=2*(a.position.bottom-a.position.y),d.top=a.position.bottom-d.height):
d.height=2*(a.position.y-a.position.top);break;default:d.top=a.position.y,d.height=a.bbox.bottom-d.top}d["line-height"]=d.height+"px";a.element=$('<div class="fx-text">').css(d);a.rendered&&(!1!==b.options.render_text||b.render_options.render_text)&&a.element.addClass("fx-text-rendered");a.wrapper=$('<div class="fx-text-wrapper">').css({"line-height":"normal","vertical-align":a.text_style.textBaseline});a.text_element=$('<div class="fx-text-inner" data-layer="'+a.slug+'">').css({font:a.text_style.font,
color:a.text_style.fillStyle}).text(a.text).on("mousedown",function(){if(!b.options.disable_text_edit){var d=a.element.hasClass("fx-active"),g=a.element.hasClass("fx-text-rendered"),h=a.overlay.find(".fx-active").not(a.element);h.length&&(a.deactivate(h),b.active_text=null);d||(a.element.addClass("fx-active").removeClass("fx-text-rendered").trigger("activate",c),b.active_text=a);b.elements.overlay.addClass("fx-editing-text").removeClass("fx-editing-sticker");g&&b.unrender_editables()}}).on("dblclick",
function(){a.editable=!0;a.element.addClass("fx-editable");a.text_element.attr("contenteditable",!0).focus();var b,c;document.createRange?(b=document.createRange(),b.selectNodeContents(a.text_element.get(0)),b.collapse(!1),c=window.getSelection(),c.removeAllRanges(),c.addRange(b)):document.selection&&(b=document.body.createTextRange(),b.moveToElementText(a.text_element.get(0)),b.collapse(!1),b.select())}).on("keyup",function(){a.check_size()});a.element.append(a.wrapper);a.wrapper.append(a.text_element);
a.wrapper.append($('<a class="fx-delete-layer fx-text-button">\u2717</a>').css({position:"absolute",top:0,left:0}).click(function(){a.remove()}));a.wrapper.append($('<a class="fx-render-layer fx-text-button">\u2714</a>').css({position:"absolute",top:0,right:0}).click(function(){!1!==b.options.render_text||b.render_options.render_text?b.rerender_editables():a.deactivate()}));a.dragable&&(a.mousemove_drag=function(b){if(!a.rendered&&!a.editable){var c={},d,e=a.bbox.right-a.bbox.left;switch(a.text_style.textAlign){case "end":case "right":c.width=
Math.min(b.pageX+a.drag_from.right-a.bbox.left,e);break;case "center":d=(a.drag_from.right-a.drag_from.left)/2;d=b.pageX+d+a.bbox.left;c.width=2*(d-a.bbox.left-a.bbox.left);c.width>e&&(c.left=a.bbox.left+(c.width-e),c.left=Math.min(c.left,a.bbox.left+e),c.width=e-(c.left-a.bbox.left));break;default:c.left=Math.max(a.bbox.left,b.pageX-a.drag_from.left),c.width=a.bbox.right-c.left}e=a.bbox.bottom-a.bbox.top;d=a.text_element.innerHeight()-18;switch(a.text_style.textBaseline){case "hanging":case "alphabetic":case "ideographic":case "bottom":c.height=
Math.min(b.pageY+a.drag_from.bottom-a.bbox.top,e);break;case "middle":d=(a.drag_from.bottom-a.drag_from.top)/2;d=b.pageY+d+a.bbox.top;c.height=2*(d-a.bbox.top-a.bbox.top);c.height>e&&(c.top=a.bbox.top+(c.height-e),c.top=Math.min(c.top,a.bbox.top+e-a.text_style.lineHeight),c.height=e-(c.top-a.bbox.top));break;default:c.top=Math.min(a.bbox.bottom-d,b.pageY-a.drag_from.top),c.top=Math.max(a.bbox.top,c.top),c.height=a.bbox.bottom-c.top}c.height=Math.max(c.height,a.text_style.lineHeight);c["line-height"]=
c.height+"px";a.element.css(c)}},a.mouseup=function(){b.elements.wrapper.off("mousemove",a.mousemove_drag)},b.elements.wrapper.on("mouseup",a.mouseup),a.element.on("mousedown",function(c){if(!a.rendered){var d=parseInt(a.element.css("left"),10),h=parseInt(a.element.css("top"),10),e=parseInt(a.element.css("width"),10),l=parseInt(a.element.css("height"),10);a.drag_from={left:c.pageX-d,right:d+e-c.pageX,top:c.pageY-h,bottom:h+l-c.pageY,event:c};b.elements.wrapper.on("mousemove",a.mousemove_drag)}b.elements.overlay.addClass("fx-editing-text").removeClass("fx-editing-sticker")}));
a.text_style.fontSize=parseInt(a.text_element.css("font-size"),10)*a.y_scale_factor;a.text_element.css("font-size",a.text_style.fontSize);a.text_style.lineHeight=a.text_element.css("line-height");"%"==a.text_style.lineHeight.substr(-1)?a.text_style.lineHeight=parseInt(a.text_style.lineHeight,10)/100*a.text_style.fontSize:a.text_style.lineHeight=parseInt(a.text_style.lineHeight,10)*a.y_scale_factor;a.text_element.css("line-height",a.text_style.lineHeight+"px").data("line-height-multiplier",a.text_style.lineHeight/
a.text_style.fontSize);a.overlay.append(a.element)}};SnaprFX.filters.text.prototype.change_style=function(c){this.text_element.css(c);"text-align"in c&&this.element.css("text-align",c["text-align"]);this.check_size()};
SnaprFX.filters.text.prototype.check_size=function(c){this.text_style.fontSize=parseInt(this.text_element.css("font-size"),10);this.text_style.lineHeight=parseInt(this.text_element.css("line-height"),10);for(c=1E3;c&&(this.text_element.width()>this.element.width()||this.text_element.height()>Math.round(this.element.height()));)c--,this.text_style.fontSize*=0.99,this.text_element.css("font-size",this.text_style.fontSize),this.text_style.lineHeight*=0.99,this.text_element.css("line-height",this.text_style.lineHeight+
"px");c||console.warn("check_size shrunk text 1000 times without success!")};SnaprFX.filters.text.prototype.remove=function(){this.element.hide();this.spec.removed=!0};SnaprFX.filters.text.prototype.unrender=function(){this.element.removeClass("fx-text-rendered")};SnaprFX.filters.text.prototype.rerender=function(){this.element.addClass("fx-text-rendered")};
SnaprFX.filters.text.prototype.deactivate=function(c){(c||this.element).removeClass("fx-editable").removeClass("fx-active").trigger("deactivate").find(".fx-text-inner").attr("contenteditable",!1);this.editable=!1};SnaprFX.filters.text.prototype.process=function(c,b){return!this.rendered?[0,0,0,0]:[this.pixels[c],this.pixels[c+1],this.pixels[c+2],this.pixels[c+3]]};var css=".fx-active-border{margin:-2px;border:solid rgba(240,240,240,.8) 2px;border-radius:4px;box-shadow:0 0 3px rgba(0,0,0,.3)}.fx-text{pointer-events:none}.fx-text.fx-text-rendered{opacity:0}.fx-text .fx-text-wrapper{pointer-events:auto;position:relative;display:inline-block;margin:-9px}.fx-text .fx-text-inner{user-select:none;-webkit-user-select:none;-moz-user-select:none;padding:9px;outline:0;display:inline-block}.fx-text.fx-editable .fx-text-inner{user-select:text;-webkit-user-select:text;-moz-user-select:text;background-color:rgba(255,255,255,.2)}.fx-text .fx-text-button{display:none}.fx-text .fx-text-edit-note{display:none;background:#fff;color:#000;position:absolute;height:12px;top:0;left:10%;right:10%}.fx-text .fx-text-edit-note .fx-text-edit-note-not-editing{display:block}.fx-text .fx-text-edit-note .fx-text-edit-note-editing{display:none}.fx-text.fx-editable .fx-text-edit-note-not-editing{display:none}.fx-text.fx-editable .fx-text-edit-note-editing{display:block}.fx-text.fx-active .fx-text-edit-note{display:block}.fx-text.fx-active .fx-text-inner{margin:-2px;border:solid rgba(240,240,240,.8) 2px;border-radius:4px;box-shadow:0 0 3px rgba(0,0,0,.3)}.fx-text.fx-active .fx-text-button{display:block}.fx-sticker{padding:.5em;-webkit-user-select:none;opacity:1;transition:0}.fx-sticker .fx-sticker-image{width:100%;height:100%}.fx-sticker.fx-sticker-rendered{opacity:0;transition:opacity .4s linear}.fx-sticker .fx-sticker-handle{display:none}.fx-sticker.fx-active{margin:-2px;border:solid rgba(240,240,240,.8) 2px;border-radius:4px;box-shadow:0 0 3px rgba(0,0,0,.3)}.fx-sticker.fx-active .fx-sticker-handle{display:block}.fx-sticker .fx-remove-sticker{top:0;left:0;background:#000;color:#fff}.fx-sticker .fx-render-sticker{top:0;right:0}.fx-sticker .fx-scale-sticker{bottom:0;right:0;font-weight:700}.fx-text-disabled .fx-text{pointer-events:none}.fx-stickers-disabled .fx-sticker{pointer-events:none}.fx-editing-text .fx-text{z-index:2}.fx-editing-text .fx-text.fx-active{z-index:3}.fx-editing-sticker .fx-sticker{z-index:2}.fx-editing-sticker .fx-sticker.fx-active{z-index:3}.fx-text-button,.fx-sticker-handle{background-color:#ff0;padding:4px;display:block;min-width:12px;min-height:12px;border-radius:20px;border:#fff solid 2px;font-size:12px;line-height:12px;text-align:center;color:#000;margin:-12px;box-shadow:0 0 3px rgba(0,0,0,.3);cursor:pointer;position:absolute}.fx-delete-layer{background-color:#000;color:#fff}",
htmlDiv=document.createElement("div");htmlDiv.innerHTML="<p>x</p><style>"+css+"</style>";document.getElementsByTagName("head")[0].appendChild(htmlDiv.childNodes[1]);
