var JpegMeta=function(){if(this.JpegMeta)throw Error("Library included multiple times");var b=this.JpegMeta={};b.parseNum=function(c,a,b,f){var g,h;c=">"===c;void 0===b&&(b=0);void 0===f&&(f=a.length-b);for(c?g=b:g=b+f-1;c?g<b+f:g>=b;c?g++:g--)h<<=8,h+=a.charCodeAt(g);return h};b.parseSnum=function(c,a,b,f){var g,h,e;c=">"===c;void 0===b&&(b=0);void 0===f&&(f=a.length-b);for(c?g=b:g=b+f-1;c?g<b+f:g>=b;c?g++:g--)void 0===e&&(e=128===(a.charCodeAt(g)&128)),h<<=8,h+=e?~a.charCodeAt(g)&255:a.charCodeAt(g);
e&&(h=-1*(h+1));return h};b.Rational=function(c,a){this.num=c;this.den=a||1;return this};b.Rational.prototype.toString=function(){return 0===this.num||1===this.den?""+this.num:1===this.num?this.num+" / "+this.den:this.num/this.den};b.Rational.prototype.asFloat=function(){return this.num/this.den};b.MetaGroup=function(c,a){this.fieldName=c;this.description=a;this.metaProps={};return this};b.MetaGroup.prototype._addProperty=function(c,a,d){c=new b.MetaProp(c,a,d);this[c.fieldName]=c;this.metaProps[c.fieldName]=
c};b.MetaGroup.prototype.toString=function(){return"[MetaGroup "+this.description+"]"};b.MetaProp=function(c,a,b){this.fieldName=c;this.description=a;this.value=b;return this};b.MetaProp.prototype.toString=function(){return""+this.value};this.JpegMeta.JpegFile=function(c,a){var d=this._SOS;this.metaGroups={};this._binary_data=c;this.filename=a;var f=0,g=0,h,e;if(this._binary_data.slice(0,2)!==this._SOI_MARKER)throw Error("Doesn't look like a JPEG file. First two bytes are "+this._binary_data.charCodeAt(0)+
","+this._binary_data.charCodeAt(1)+".");for(f+=2;f<this._binary_data.length;){h=this._binary_data.charCodeAt(f++);e=this._binary_data.charCodeAt(f++);g=f;if(h!=this._DELIM)break;if(e===d)break;h=b.parseNum(">",this._binary_data,f,2);for(f+=h;f<this._binary_data.length;)if(h=this._binary_data.charCodeAt(f++),h==this._DELIM&&(h=this._binary_data.charCodeAt(f++),0!=h)){f-=2;break}if(h=this._markers[e]?this._markers[e][1]:void 0)this[h](e,g+2)}if(void 0===this.general)throw Error("Invalid JPEG file.");
return this};this.JpegMeta.JpegFile.prototype.toString=function(){return"[JpegFile "+this.filename+" "+this.general.type+" "+this.general.pixelWidth+"x"+this.general.pixelHeight+" Depth: "+this.general.depth+"]"};this.JpegMeta.JpegFile.prototype._SOI_MARKER="\u00ff\u00d8";this.JpegMeta.JpegFile.prototype._DELIM=255;this.JpegMeta.JpegFile.prototype._EOI=217;this.JpegMeta.JpegFile.prototype._SOS=218;this.JpegMeta.JpegFile.prototype._sofHandler=function(c,a){if(void 0!==this.general)throw Error("Unexpected multiple-frame image");
this._addMetaGroup("general","General");this.general._addProperty("depth","Depth",b.parseNum(">",this._binary_data,a,1));this.general._addProperty("pixelHeight","Pixel Height",b.parseNum(">",this._binary_data,a+1,2));this.general._addProperty("pixelWidth","Pixel Width",b.parseNum(">",this._binary_data,a+3,2));this.general._addProperty("type","Type",this._markers[c][2])};this.JpegMeta.JpegFile.prototype._JFIF_IDENT="JFIF\x00";this.JpegMeta.JpegFile.prototype._JFXX_IDENT="JFXX\x00";this.JpegMeta.JpegFile.prototype._EXIF_IDENT=
"Exif\x00";this.JpegMeta.JpegFile.prototype._types={1:["BYTE",1],2:["ASCII",1],3:["SHORT",2],4:["LONG",4],5:["RATIONAL",8],6:["SBYTE",1],7:["UNDEFINED",1],8:["SSHORT",2],9:["SLONG",4],10:["SRATIONAL",8],11:["FLOAT",4],12:["DOUBLE",8]};this.JpegMeta.JpegFile.prototype._tifftags={256:["Image width","ImageWidth"],257:["Image height","ImageLength"],258:["Number of bits per component","BitsPerSample"],259:["Compression scheme","Compression",{1:"uncompressed",6:"JPEG compression"}],262:["Pixel composition",
"PhotmetricInerpretation",{2:"RGB",6:"YCbCr"}],274:["Orientation of image","Orientation",{1:"Normal",2:"Reverse?",3:"Upside-down",4:"Upside-down Reverse",5:"90 degree CW",6:"90 degree CW reverse",7:"90 degree CCW",8:"90 degree CCW reverse"}],277:["Number of components","SamplesPerPixel"],284:["Image data arrangement","PlanarConfiguration",{1:"chunky format",2:"planar format"}],530:["Subsampling ratio of Y to C","YCbCrSubSampling"],531:["Y and C positioning","YCbCrPositioning",{1:"centered",2:"co-sited"}],
282:["X Resolution","XResolution"],283:["Y Resolution","YResolution"],296:["Resolution Unit","ResolutionUnit",{2:"inches",3:"centimeters"}],273:["Image data location","StripOffsets"],278:["Number of rows per strip","RowsPerStrip"],279:["Bytes per compressed strip","StripByteCounts"],513:["Offset to JPEG SOI","JPEGInterchangeFormat"],514:["Bytes of JPEG Data","JPEGInterchangeFormatLength"],301:["Transfer function","TransferFunction"],318:["White point chromaticity","WhitePoint"],319:["Chromaticities of primaries",
"PrimaryChromaticities"],529:["Color space transformation matrix coefficients","YCbCrCoefficients"],532:["Pair of black and white reference values","ReferenceBlackWhite"],306:["Date and time","DateTime"],270:["Image title","ImageDescription"],271:["Make","Make"],272:["Model","Model"],305:["Software","Software"],315:["Person who created the image","Artist"],316:["Host Computer","HostComputer"],33432:["Copyright holder","Copyright"],34665:["Exif tag","ExifIfdPointer"],34853:["GPS tag","GPSInfoIfdPointer"]};
this.JpegMeta.JpegFile.prototype._exiftags={36864:["Exif Version","ExifVersion"],40960:["FlashPix Version","FlashpixVersion"],40961:["Color Space","ColorSpace"],37121:["Meaning of each component","ComponentsConfiguration"],37122:["Compressed Bits Per Pixel","CompressedBitsPerPixel"],40962:["Pixel X Dimension","PixelXDimension"],40963:["Pixel Y Dimension","PixelYDimension"],37500:["Manufacturer notes","MakerNote"],37510:["User comments","UserComment"],40964:["Related audio file","RelatedSoundFile"],
36867:["Date Time Original","DateTimeOriginal"],36868:["Date Time Digitized","DateTimeDigitized"],37520:["DateTime subseconds","SubSecTime"],37521:["DateTimeOriginal subseconds","SubSecTimeOriginal"],37522:["DateTimeDigitized subseconds","SubSecTimeDigitized"],33434:["Exposure time","ExposureTime"],33437:["FNumber","FNumber"],34850:["Exposure program","ExposureProgram"],34852:["Spectral sensitivity","SpectralSensitivity"],34855:["ISO Speed Ratings","ISOSpeedRatings"],34856:["Optoelectric coefficient",
"OECF"],37377:["Shutter Speed","ShutterSpeedValue"],37378:["Aperture Value","ApertureValue"],37379:["Brightness","BrightnessValue"],37380:["Exposure Bias Value","ExposureBiasValue"],37381:["Max Aperture Value","MaxApertureValue"],37382:["Subject Distance","SubjectDistance"],37383:["Metering Mode","MeteringMode"],37384:["Light Source","LightSource"],37385:["Flash","Flash"],37386:["Focal Length","FocalLength"],37396:["Subject Area","SubjectArea"],41483:["Flash Energy","FlashEnergy"],41484:["Spatial Frequency Response",
"SpatialFrequencyResponse"],41486:["Focal Plane X Resolution","FocalPlaneXResolution"],41487:["Focal Plane Y Resolution","FocalPlaneYResolution"],41488:["Focal Plane Resolution Unit","FocalPlaneResolutionUnit"],41492:["Subject Location","SubjectLocation"],41493:["Exposure Index","ExposureIndex"],41495:["Sensing Method","SensingMethod"],41728:["File Source","FileSource"],41729:["Scene Type","SceneType"],41730:["CFA Pattern","CFAPattern"],41985:["Custom Rendered","CustomRendered"],41986:["Exposure Mode",
"Exposure Mode"],41987:["White Balance","WhiteBalance"],41988:["Digital Zoom Ratio","DigitalZoomRatio"],41990:["Scene Capture Type","SceneCaptureType"],41991:["Gain Control","GainControl"],41992:["Contrast","Contrast"],41993:["Saturation","Saturation"],41994:["Sharpness","Sharpness"],41995:["Device settings description","DeviceSettingDescription"],41996:["Subject distance range","SubjectDistanceRange"],42016:["Unique image ID","ImageUniqueID"],40965:["Interoperability tag","InteroperabilityIFDPointer"]};
this.JpegMeta.JpegFile.prototype._gpstags={"0":["GPS tag version","GPSVersionID"],1:["North or South Latitude","GPSLatitudeRef"],2:["Latitude","GPSLatitude"],3:["East or West Longitude","GPSLongitudeRef"],4:["Longitude","GPSLongitude"],5:["Altitude reference","GPSAltitudeRef"],6:["Altitude","GPSAltitude"],7:["GPS time (atomic clock)","GPSTimeStamp"],8:["GPS satellites usedd for measurement","GPSSatellites"],9:["GPS receiver status","GPSStatus"],10:["GPS mesaurement mode","GPSMeasureMode"],11:["Measurement precision",
"GPSDOP"],12:["Speed unit","GPSSpeedRef"],13:["Speed of GPS receiver","GPSSpeed"],14:["Reference for direction of movement","GPSTrackRef"],15:["Direction of movement","GPSTrack"],16:["Reference for direction of image","GPSImgDirectionRef"],17:["Direction of image","GPSImgDirection"],18:["Geodetic survey data used","GPSMapDatum"],19:["Reference for latitude of destination","GPSDestLatitudeRef"],20:["Latitude of destination","GPSDestLatitude"],21:["Reference for longitude of destination","GPSDestLongitudeRef"],
22:["Longitude of destination","GPSDestLongitude"],23:["Reference for bearing of destination","GPSDestBearingRef"],24:["Bearing of destination","GPSDestBearing"],25:["Reference for distance to destination","GPSDestDistanceRef"],26:["Distance to destination","GPSDestDistance"],27:["Name of GPS processing method","GPSProcessingMethod"],28:["Name of GPS area","GPSAreaInformation"],29:["GPS Date","GPSDateStamp"],30:["GPS differential correction","GPSDifferential"]};this.JpegMeta.JpegFile.prototype._markers=
{192:["SOF0","_sofHandler","Baseline DCT"],193:["SOF1","_sofHandler","Extended sequential DCT"],194:["SOF2","_sofHandler","Progressive DCT"],195:["SOF3","_sofHandler","Lossless (sequential)"],197:["SOF5","_sofHandler","Differential sequential DCT"],198:["SOF6","_sofHandler","Differential progressive DCT"],199:["SOF7","_sofHandler","Differential lossless (sequential)"],200:["JPG",null,"Reserved for JPEG extensions"],201:["SOF9","_sofHandler","Extended sequential DCT"],202:["SOF10","_sofHandler","Progressive DCT"],
203:["SOF11","_sofHandler","Lossless (sequential)"],205:["SOF13","_sofHandler","Differential sequential DCT"],206:["SOF14","_sofHandler","Differential progressive DCT"],207:["SOF15","_sofHandler","Differential lossless (sequential)"],196:["DHT",null,"Define Huffman table(s)"],204:["DAC",null,"Define arithmetic coding conditioning(s)"],208:["RST0",null,"Restart with modulo 8 count \u201c0\u201d"],209:["RST1",null,"Restart with modulo 8 count \u201c1\u201d"],210:["RST2",null,"Restart with modulo 8 count \u201c2\u201d"],
211:["RST3",null,"Restart with modulo 8 count \u201c3\u201d"],212:["RST4",null,"Restart with modulo 8 count \u201c4\u201d"],213:["RST5",null,"Restart with modulo 8 count \u201c5\u201d"],214:["RST6",null,"Restart with modulo 8 count \u201c6\u201d"],215:["RST7",null,"Restart with modulo 8 count \u201c7\u201d"],216:["SOI",null,"Start of image"],217:["EOI",null,"End of image"],218:["SOS",null,"Start of scan"],219:["DQT",null,"Define quantization table(s)"],220:["DNL",null,"Define number of lines"],221:["DRI",
null,"Define restart interval"],222:["DHP",null,"Define hierarchical progression"],223:["EXP",null,"Expand reference component(s)"],224:["APP0","_app0Handler","Reserved for application segments"],225:["APP1","_app1Handler"],226:["APP2",null],227:["APP3",null],228:["APP4",null],229:["APP5",null],230:["APP6",null],231:["APP7",null],232:["APP8",null],233:["APP9",null],234:["APP10",null],235:["APP11",null],236:["APP12",null],237:["APP13",null],238:["APP14",null],239:["APP15",null],240:["JPG0",null],241:["JPG1",
null],242:["JPG2",null],243:["JPG3",null],244:["JPG4",null],245:["JPG5",null],246:["JPG6",null],247:["JPG7",null],248:["JPG8",null],249:["JPG9",null],250:["JPG10",null],251:["JPG11",null],252:["JPG12",null],253:["JPG13",null],254:["COM",null],1:["JPG13",null]};this.JpegMeta.JpegFile.prototype._addMetaGroup=function(c,a){var d=new b.MetaGroup(c,a);this[d.fieldName]=d;return this.metaGroups[d.fieldName]=d};this.JpegMeta.JpegFile.prototype._parseIfd=function(c,a,d,f,g,h,e){var l=b.parseNum(c,a,d+f,2),
k,n,m,p,q,r,s,t,u;u=this._addMetaGroup(h,e);for(h=0;h<l;h++)if(k=d+f+2+12*h,e=b.parseNum(c,a,k,2),m=b.parseNum(c,a,k+2,2),p=b.parseNum(c,a,k+4,4),q=b.parseNum(c,a,k+8,4),void 0!==this._types[m]){n=this._types[m][0];m=this._types[m][1];q=4>=m*p?k+8:d+q;if("UNDEFINED"==n)r=a.slice(q,q+p);else if("ASCII"==n)r=a.slice(q,q+p),r=r.split("\x00")[0];else{r=[];for(k=0;k<p;k++,q+=m)("BYTE"==n||"SHORT"==n||"LONG"==n)&&r.push(b.parseNum(c,a,q,m)),("SBYTE"==n||"SSHORT"==n||"SLONG"==n)&&r.push(b.parseSnum(c,a,
q,m)),"RATIONAL"==n&&(s=b.parseNum(c,a,q,4),t=b.parseNum(c,a,q+4,4),r.push(new b.Rational(s,t))),"SRATIONAL"==n&&(s=b.parseSnum(c,a,q,4),t=b.parseSnum(c,a,q+4,4),r.push(new b.Rational(s,t))),r.push();1===p&&(r=r[0])}null!=g[e]&&u._addProperty(g[e][1],g[e][0],r)}};this.JpegMeta.JpegFile.prototype._jfifHandler=function(c,a){if(void 0!==this.jfif)throw Error("Multiple JFIF segments found");this._addMetaGroup("jfif","JFIF");this.jfif._addProperty("version_major","Version Major",this._binary_data.charCodeAt(a+
5));this.jfif._addProperty("version_minor","Version Minor",this._binary_data.charCodeAt(a+6));this.jfif._addProperty("version","JFIF Version",this.jfif.version_major.value+"."+this.jfif.version_minor.value);this.jfif._addProperty("units","Density Unit",this._binary_data.charCodeAt(a+7));this.jfif._addProperty("Xdensity","X density",b.parseNum(">",this._binary_data,a+8,2));this.jfif._addProperty("Ydensity","Y Density",b.parseNum(">",this._binary_data,a+10,2));this.jfif._addProperty("Xthumbnail","X Thumbnail",
b.parseNum(">",this._binary_data,a+12,1));this.jfif._addProperty("Ythumbnail","Y Thumbnail",b.parseNum(">",this._binary_data,a+13,1))};this.JpegMeta.JpegFile.prototype._app0Handler=function(c,a){this._binary_data.slice(a,a+5)==this._JFIF_IDENT&&this._jfifHandler(c,a)};this.JpegMeta.JpegFile.prototype._app1Handler=function(c,a){this._binary_data.slice(a,a+5)==this._EXIF_IDENT&&this._exifHandler(c,a+6)};b.JpegFile.prototype._exifHandler=function(c,a){if(void 0!==this.exif)throw Error("Multiple JFIF segments found");
var d,f;d=this._binary_data.slice(a,a+2);if("II"===d)d="<";else if("MM"===d)d=">";else throw Error("Malformed TIFF meta-data. Unknown endianess: "+d);f=b.parseNum(d,this._binary_data,a+2,2);if(42!==f)throw Error("Malformed TIFF meta-data. Bad magic: "+f);f=b.parseNum(d,this._binary_data,a+4,4);this._parseIfd(d,this._binary_data,a,f,this._tifftags,"tiff","TIFF");this.tiff.ExifIfdPointer&&this._parseIfd(d,this._binary_data,a,this.tiff.ExifIfdPointer.value,this._exiftags,"exif","Exif");this.tiff.GPSInfoIfdPointer&&
(this._parseIfd(d,this._binary_data,a,this.tiff.GPSInfoIfdPointer.value,this._gpstags,"gps","GPS"),this.gps.GPSLatitude&&(d=this.gps.GPSLatitude.value[0].asFloat()+1/60*this.gps.GPSLatitude.value[1].asFloat()+1/3600*this.gps.GPSLatitude.value[2].asFloat(),"S"===this.gps.GPSLatitudeRef.value&&(d=-d),this.gps._addProperty("latitude","Dec. Latitude",d)),this.gps.GPSLongitude&&(d=this.gps.GPSLongitude.value[0].asFloat()+1/60*this.gps.GPSLongitude.value[1].asFloat()+1/3600*this.gps.GPSLongitude.value[2].asFloat(),
"W"===this.gps.GPSLongitudeRef.value&&(d=-d),this.gps._addProperty("longitude","Dec. Longitude",d)))};return this.JpegMeta}();"function"===typeof define&&define.amd&&define(function(){return JpegMeta});var debug_logging=!1,debug_canvas=!1,R=0,G=1,B=2,O=3,SnaprFX=function(b){return this.init(b)};window.SnaprFX=SnaprFX;SnaprFX.prototype.deferred=null;
SnaprFX.prototype.init=function(b){var c=this;c.deferred=$.Deferred();c.options=b;SnaprFX.utils.read_exif(c.options.url).done(function(a){c.exif=a;c.load_original(!0).done(function(){c.canvas=new SnaprFX.Canvas({width:c.original.width,height:c.original.height});c.canvas.context.drawImage(c.original.canvas,0,0);c.update_element();setTimeout(function(){c.create_overlay_elements();c.deferred.resolve()},1)})});c.load_filter_pack=$.Deferred();$.ajax({url:c.options.filter_pack+"filter-pack.json",success:function(a){c.filter_pack=
a.filter_pack;c.filter_pack.base_path=c.options.filter_pack;c.load_filter_pack.resolve(c.filter_pack);c.load_fonts()}});c.load_sticker_pack=$.Deferred();$.ajax({url:c.options.sticker_pack+"sticker-pack.json",success:function(a){c.sticker_pack=a.sticker_pack;c.sticker_pack.by_slug={};c.sticker_pack.base_path=c.options.sticker_pack;$.each(c.sticker_pack.sections,function(a,b){console.log(b);$.each(b.stickers,function(a,b){c.sticker_pack.by_slug[b.slug]=b})});c.load_sticker_pack.resolve(c.sticker_pack)}});
c.filter_specs={};c.stickers=[];c.text=[]};SnaprFX.prototype.set_url=function(b,c){var a=this;this.options.url=b;var d=$.Deferred();SnaprFX.utils.read_exif(a.options.url).done(function(c){a.exif=c;a.load_original(!0).done(function(){a.apply_filter({editable:a.render_options&&a.render_options.editable});d.resolve()})});return d};
SnaprFX.prototype.set_options=function(b){var c=this.options.render_text;$.extend(this.options,b);!c&&this.options.render_text&&this.apply_filter({render_text:!0,editable:!1});this.elements.overlay.toggleClass("fx-text-disabled",!0===this.options.disable_text_edit);this.elements.overlay.toggleClass("fx-stickers-disabled",!0===this.options.disable_sticker_edit)};
SnaprFX.prototype.load_fonts=function(){var b=this;$.each(b.filter_pack.sections,function(c,a){$.each(a.filters,function(a,c){var g=b.filter_pack.base_path+"filters/"+c.slug+"/";$.ajax({url:g+"filter.json",success:function(a){b.filter_specs[c.slug]=a.filter;a.filter.fonts&&$.each(a.filter.fonts,function(a,c){var b;b="@font-face {"+("font-family: '"+c["font-family"]+"';");c["font-weight"]&&(b+="font-weight: "+c["font-weight"]+";");c["font-style"]&&(b+="font-style: "+c["font-style"]+";");c.eot&&(b+=
"src: url('"+g+"fonts/"+c.eot+"');");b+="src:";c.eot&&(b+="url('"+g+"fonts/"+c.eot+"?#iefix') format('embedded-opentype'),");c.woff&&(b+="url('"+g+"fonts/"+c.woff+"') format('woff'),");c.ttf&&(b+="url('"+g+"fonts/"+c.ttf+"') format('truetype'),");c.svg&&(b+="url('"+g+"fonts/"+c.svg+"#"+c["font-family"]+"') format('svg');");$("<style>"+(b+"}")+"</style>").appendTo(document.head);$('<span style="font-family: '+c["font-family"]+'"></span>').appendTo(document.body)})}})})})};
SnaprFX.prototype.load_original=function(b){var c=this,a=$.Deferred();c.original=new SnaprFX.Canvas({url:c.options.url,size:c.options.size,aspect:c.options.aspect,width:c.options.width,height:c.options.height,orientation:c.exif&&c.exif.orientation});c.original.deferred.done(function(){!1===b?a.resolve():c.render_stickers().done(function(){a.resolve()})});return a};SnaprFX.prototype.update_element=function(){this.options.element.attr("src",this.canvas.get_data_url())};
SnaprFX.prototype.revert=function(){this.current_filter=null;this.canvas.context.drawImage(this.original.canvas,0,0);this.update_element()};
SnaprFX.prototype.apply_filter=function(b){function c(){var c=a.filter_specs[a.current_filter];c&&(c.layer_index=-1);if(a.render_options.region)debug_logging&&console.log("region",a.render_options.region),c=a.render_options.region,a.canvas.context.drawImage(a.original.canvas,c.left,c.top,c.width,c.height,c.left,c.top,c.width,c.height);else{var f=!1,c=function(){f&&a.canvas.context.drawImage(a.original.canvas,0,0);f=!0};a.canvas.set_size(a.render_options.width,a.render_options.height).done(c);a.original.set_size(a.render_options.width,
a.render_options.height).done(c)}c=function(){a.pixels=a.canvas.get_data();a.apply_next_layer()};!b.editable||a.options.disable_sticker_edit?a.render_stickers().done(c):c()}var a=this;$(document.body).addClass("fx-processing");b=$.extend({filter:a.current_filter,editable:!1,width:a.options.width,height:a.options.height},b);a.render_options=b;a.deferred=$.Deferred();b.editable||a.deferred.done(function(){(!1!==a.options.render_text||a.render_options.render_text)&&$.each(a.text,function(a,c){c.rerender()});
$.each(a.stickers,function(a,c){c.rerender()})});b.filter!=a.current_filter&&a.elements.overlay.find(".fx-text").remove();debug_logging&&console.group(b.filter);(a.current_filter=b.filter)?b.filter in a.filter_specs?setTimeout(c,4):$.ajax({url:a.filter_pack.base_path+"filters/"+b.filter+"/filter.json",success:function(d){debug_logging&&console.log("loaded",b.filter);a.filter_specs[b.filter]=d.filter;setTimeout(c,4)}}):setTimeout(c,4)};
SnaprFX.prototype.output=function(b){var c=this,a=$.Deferred();c.apply_filter({output:!0,width:b.width,height:b.height});c.deferred.done(function(){a.resolve(c.canvas.get_data_url())});return a};
SnaprFX.prototype.apply_next_layer=function(){var b=this;if(b.current_filter){var c=b.filter_specs[b.current_filter];c.layer_index++;if(c.layer_index>=c.layers.length)b.finish();else{debug_logging&&console.time("applying "+c.layers[c.layer_index].type+" layer");debug_logging&&console.log("applying",c.layers[c.layer_index].type,"layer");var a=c.layers[c.layer_index];a.filter?a.filter.update&&a.filter.update(a,b):a.filter=new SnaprFX.filters[a.type](a,b);a.blender=a.blender||new SnaprFX.Blender(a.blending_mode||
"normal");a.filter.deferred.done(function(){function d(){for(var d=b.render_options.region||{left:0,top:0,width:b.canvas.width,height:b.canvas.height},h,k=d.top;k<d.top+d.height;k+=1)for(var n=d.left;n<d.left+d.width;n+=1){h=4*(k*b.canvas.width+n);var m;m=a.filter.whole_canvas?[f[h],f[h+1],f[h+2],f[h+3]]:a.filter.process(h,[b.pixels[h],b.pixels[h+1],b.pixels[h+2]]);var p=m[O],p=0<=p?p/255:1;a.mask_image&&(p*=g[h]/255);p*=a.opacity/100;m=a.blender.process([b.pixels[h],b.pixels[h+1],b.pixels[h+2]],
[m[R],m[G],m[B]],p);b.pixels[h]=m[R];b.pixels[h+1]=m[G];b.pixels[h+2]=m[B]}debug_logging&&console.timeEnd("applying "+c.layers[c.layer_index].type+" layer");b.apply_next_layer()}var f;a.filter.whole_canvas&&(0!==c.layer_index&&b.canvas.put_data(b.pixels),a.filter.process(b.canvas),f=b.canvas.get_data());var g;if(a.mask_image){var h=new SnaprFX.Canvas({url:b.filter_pack.base_path+"filters/"+c.slug+"/"+a.mask_image,width:b.canvas.width,height:b.canvas.height});h.deferred.done(function(){g=h.get_data();
d()})}else d()})}}else b.finish()};SnaprFX.prototype.finish=function(){debug_logging&&console.time("writing data back");this.canvas.put_data(this.pixels);this.render_options.output||this.update_element();this.deferred.resolve();$(document.body).removeClass("fx-processing");debug_logging&&console.timeEnd("writing data back");debug_logging&&console.groupEnd(this.current_filter)};
SnaprFX.prototype.unrender_editables=function(){this.options.disable_sticker_edit||$.each(this.stickers,function(b,c){c.unrender()});this.options.disable_text_edit||$.each(this.text,function(b,c){c.unrender()});this.apply_filter({editable:!0})};SnaprFX.prototype.rerender_editables=function(){this.apply_filter({editable:!1})};
SnaprFX.prototype.create_overlay_elements=function(){var b=this;b.elements={image:b.options.element};b.elements.overlay=$('<div class="fx-overlay-layer">').css({position:"absolute",top:0,left:0,height:"100%",width:"100%"}).click(function(c){$(c.target).closest(".fx-text-wrapper").length||(b.render_options.editable&&!$(c.target).closest(".fx-sticker").length&&b.rerender_editables(),b.active_text&&b.active_text.deactivate())});b.elements.wrapper=$('<div class="fx-wrapper">').css({position:"relative",
height:b.elements.image.height(),width:b.elements.image.width()});b.elements.wrapper.insertAfter(b.elements.image);b.elements.image.appendTo(b.elements.wrapper);b.elements.overlay.appendTo(b.elements.wrapper);b.elements.overlay.offset_cache=b.elements.overlay.offset()};"function"===typeof define&&define.amd&&define(function(){return SnaprFX});SnaprFX.utils={rotated_dimensions:function(b,c,a){var d=Math.abs(Math.cos(a)*b)+Math.abs(Math.sin(a)*c);b=Math.abs(Math.sin(a)*b)+Math.abs(Math.cos(a)*c);return{width:d,height:b}},cart2polar:function(b,c){var a=Math.atan(c/b);0<c?0>b&&(a=Math.PI+a):a=0>b?Math.PI+a:2*Math.PI+a;return a},pythag:function(b,c){return Math.sqrt(Math.pow(b,2)+Math.pow(c,2))},preload_assets:function(b){console.log("oop",b);console.log("oo",b.filter_pack+"filter-pack.json");$.ajax({url:b.filter_pack+"filter-pack.json",success:function(c){$.each(c.filter_pack.sections,
function(a,c){$.each(c.filters,function(a,c){var d=b.filter_pack+"filters/"+c.slug+"/";$.ajax({url:d+"filter.json",success:function(a){a.filter.fonts&&$.each(a.filter.fonts,function(a,c){var b;b="@font-face {"+("font-family: '"+c["font-family"]+"';");c["font-weight"]&&(b+="font-weight: "+c["font-weight"]+";");c["font-style"]&&(b+="font-style: "+c["font-style"]+";");c.eot&&(b+="src: url('"+d+"fonts/"+c.eot+"');");b+="src:";c.eot&&(b+="url('"+d+"fonts/"+c.eot+"?#iefix') format('embedded-opentype'),");
c.woff&&(b+="url('"+d+"fonts/"+c.woff+"') format('woff'),");c.ttf&&(b+="url('"+d+"fonts/"+c.ttf+"') format('truetype'),");c.svg&&(b+="url('"+d+"fonts/"+c.svg+"#"+c["font-family"]+"') format('svg');");$("<style>"+(b+"}")+"</style>").appendTo(document.head);$('<span style="font-family: '+c["font-family"]+'"></span>').appendTo(document.body)});$.each(a.filter.layers,function(a,c){"image"==c.type&&((new Image).src=d+c.image.image)})}})})})}});$.ajax({url:b.sticker_pack+"sticker-pack.json",success:function(c){$.each(c.sticker_pack.sections,
function(a,c){$.each(c.stickers,function(a,c){(new Image).src=b.sticker_pack+"assets/"+c.slug+".png"})})}})},read_exif:function(b){var c=$.Deferred(),a=new XMLHttpRequest;a.open("GET",b,!0);a.responseType="arraybuffer";a.onload=function(b){var f=new FileReader;f.onloadend=function(){var b=new JpegMeta.JpegFile(this.result,"test.jpg");a=f=null;c.resolve({latitude:b.gps&&b.gps.latitude&&b.gps.latitude.value,longitude:b.gps&&b.gps.longitude&&b.gps.longitude.value,date:b.exif&&b.exif.DateTimeOriginal&&
b.exif.DateTimeOriginal.value,orientation:b.tiff&&b.tiff.Orientation&&b.tiff.Orientation.value})};b=new Blob([this.response]);f.readAsBinaryString(b)};a.send();return c},rgbToHsl:function(b,c,a){b/=255;c/=255;a/=255;var d=Math.max(b,c,a),f=Math.min(b,c,a),g,h=(d+f)/2;if(d==f)g=f=0;else{var e=d-f,f=0.5<h?e/(2-d-f):e/(d+f);switch(d){case b:g=(c-a)/e+(c<a?6:0);break;case c:g=(a-b)/e+2;break;case a:g=(b-c)/e+4}g/=6}return[g,f,h]},hslToRgb:function(b,c,a){if(0===c)a=c=b=a;else{var d=0.5>a?a*(1+c):a+c-
a*c,f=2*a-d;a=SnaprFX.utils.hueToRgb(f,d,b+1/3);c=SnaprFX.utils.hueToRgb(f,d,b);b=SnaprFX.utils.hueToRgb(f,d,b-1/3)}return[255*a,255*c,255*b]},hueToRgb:function(b,c,a){0>a&&(a+=1);1<a&&(a-=1);return a<1/6?b+6*(c-b)*a:0.5>a?c:a<2/3?b+6*(c-b)*(2/3-a):b}};SnaprFX.prototype.add_sticker=function(b){var c=this,a=new SnaprFX.sticker(b,c);c.stickers.push(a);a.deferred.done(function(){c.elements.overlay.append(a.element);a.element.addClass("fx-active").siblings(".fx-active").removeClass("fx-active")})};
SnaprFX.prototype.render_stickers=function(){function b(){var b=!0;$.each(c.stickers,function(a,c){if("pending"==c.deferred.state())return b=!1});b&&a.resolve()}var c=this,a=$.Deferred();c.original.deferred.done(function(){c.stickers.length||a.resolve();$.each(c.stickers,function(a){c.stickers[a].render(c.canvas).done(b)})});return a};
SnaprFX.sticker=function(b,c){var a=this;a.slug=b;a.parent=c;a.scale=1;a.rotation=0;a.spec=c.sticker_pack.by_slug[b];a.deferred=$.Deferred();a.load().done(function(){a.scale_factor=Math.min(c.canvas.width/c.sticker_pack.target_canvas.width,c.canvas.height/c.sticker_pack.target_canvas.height);var d;d='<div class="fx-sticker fx-sticker-rendered"><a class="fx-remove-sticker fx-sticker-handle" data-role="button" data-icon="delete" data-iconpos="notext" data-theme="e">\u2717</a><a class="fx-render-sticker fx-sticker-handle" data-role="button" data-icon="tick" data-iconpos="notext" data-theme="e">\u2714</a>';
d+='<a class="fx-scale-sticker fx-sticker-handle" data-role="button" data-icon="rotate" data-iconpos="notext" data-theme="e">R</a>';d+='<img class="fx-sticker-image" src="'+a.parent.sticker_pack.base_path+"assets/"+b+'.png">';d+="</div>";var f={position:"absolute",width:a.image.width*a.scale_factor,height:a.image.height*a.scale_factor};a.spec.position&&a.spec.position.center?(f.left=a.spec.position.center.x*a.scale_factor-f.width/2,f.top=a.spec.position.center.y*a.scale_factor-f.height/2):(f.left=
c.canvas.width/2-f.width/2,f.top=c.canvas.height/2-f.height/2);a.element=$(d).css(f);a.initial=f;a.rendered||a.element.removeClass("fx-sticker-rendered");a.element.find(".fx-render-sticker").on("click",function(a){c.rerender_editables();a.stopPropagation()});a.element.find(".fx-remove-sticker").on("click",function(){a.remove()});a.element.on("click",function(){a.parent.options.disable_sticker_edit||(a.rendered&&c.unrender_editables(),a.element.addClass("fx-active").removeClass("fx-sticker-rendered").siblings(".fx-active").removeClass("fx-active"))});
a.mousemove_drag=function(c){a.rendered||a.element.css({left:c.pageX-a.drag_from.left,top:c.pageY-a.drag_from.top})};a.mouseup=function(){c.elements.wrapper.off("mousemove",a.mousemove_drag);c.elements.wrapper.off("mousemove",a.mousemove_scale)};c.elements.wrapper.on("mouseup",a.mouseup);a.element.on("mousedown",function(b){if(!a.rendered){var d=parseInt(a.element.css("left"),10),e=parseInt(a.element.css("top"),10);a.drag_from={left:b.pageX-d,top:b.pageY-e,event:b};c.elements.wrapper.on("mousemove",
a.mousemove_drag)}c.elements.overlay.addClass("fx-editing-sticker").removeClass("fx-editing-text")});a.mousemove_scale=function(c){c.stopPropagation();if(!a.rendered){var b=SnaprFX.utils.pythag(c.pageX-a.scale_from.x,c.pageY-a.scale_from.y);a.scale=b/a.scale_from.size;a.scale=Math.max(a.scale,0.15);c=SnaprFX.utils.cart2polar(c.pageX-a.scale_from.x,c.pageY-a.scale_from.y);a.rotation=-a.scale_from.rotation+c;c=a.initial.width*a.scale;b=a.initial.height*a.scale;a.element.css({transform:"rotate("+360*
(a.rotation/(2*Math.PI))+"deg)",width:c,height:b,top:a.scale_from.y-b/2-a.parent.elements.overlay.offset_cache.top,left:a.scale_from.x-c/2-a.parent.elements.overlay.offset_cache.left})}};a.element.find(".fx-scale-sticker").on("mousedown",function(b){b.stopPropagation();window.element=a.element;if(!a.rendered){var d=a.get_dimensions(),e=a.element.find(".fx-sticker-image").offset();a.scale_from={x:e.left+d.width/2,y:e.top+d.height/2,size:SnaprFX.utils.pythag(a.element.height(),a.element.width())/2/
a.scale,scale:a.scale};a.scale_from.rotation=SnaprFX.utils.cart2polar(b.pageX-a.scale_from.x,b.pageY-a.scale_from.y)-a.rotation;c.elements.wrapper.on("mousemove",a.mousemove_scale)}});a.element.on("dragstart",function(a){a.preventDefault()});a.deferred.resolve()})};
SnaprFX.sticker.prototype.load=function(){var b=this;if(b.load_deferred)return b.load_deferred;b.load_deferred=$.Deferred();b.image=new Image;b.image.src=b.parent.sticker_pack.base_path+"assets/"+b.slug+".png";b.image.onload=function(){b.load_deferred.resolve()};return b.load_deferred};
SnaprFX.sticker.prototype.render=function(b){var c=this;c.deferred=$.Deferred();var a=c.element.find(".fx-sticker-image"),d=a.offset(),f=c.element.parent(),g=f.offset(),h=(d.left-g.left)/f.width(),e=(d.top-g.top)/f.height(),l=a.width()/f.width()*b.width,k=a.height()/f.height()*b.height,a=c.rotation,d=Math.PI;a>2*d&&(a-=2*d);0>a&&(a+=2*d);f=Math.sin(a);g=Math.cos(a);a<d/2?h+=f*k/b.width:a>1.5*d?e+=-f*l/b.height:a>d/2&&a<d?(h+=(f*k+-g*l)/b.width,e+=-g*k/b.height):(h+=-g*l/b.width,e+=(-g*k-f*l)/b.height);
c.load().done(function(){b.context.translate(h*b.width,e*b.height);b.context.rotate(c.rotation);b.context.drawImage(c.image,0,0,c.image.width,c.image.height,0,0,l,k);b.context.rotate(-c.rotation);b.context.translate(-h*b.width,-e*b.height);c.deferred.resolve()});return c.deferred};SnaprFX.sticker.prototype.unrender=function(){this.rendered=!1;this.element.removeClass("fx-sticker-rendered")};SnaprFX.sticker.prototype.rerender=function(){this.rendered=!0;this.element.addClass("fx-sticker-rendered")};
SnaprFX.sticker.prototype.remove=function(){var b=this;b.element.remove();b.parent.elements.wrapper.off("mousemove",b.mousemove).off("mouseup",b.mouseup);$.each(b.parent.stickers,function(c,a){a==b&&b.parent.stickers.splice(c,1)})};SnaprFX.sticker.prototype.get_dimensions=function(){return SnaprFX.utils.rotated_dimensions(this.element.width(),this.element.height(),-this.rotation)};SnaprFX.Canvas=function(b){var c=this;debug_logging&&console.log("canvas",b);c.options=b;c.deferred=$.Deferred();c.canvas=document.createElement("canvas");c.context=c.canvas.getContext("2d");debug_canvas&&($(document.body).append(c.canvas),$(c.canvas).css({border:"1px solid #f00",width:200}));if(b.url){debug_logging&&console.time("get image");switch(b.orientation){case 3:c.options.rotation=Math.PI;break;case 6:c.options.rotation=0.5*Math.PI;break;case 8:c.options.rotation=1.5*Math.PI;break;default:c.options.rotation=
0}c.image=new Image;c.image.src=b.url;c.image.onload=function(){c.place_image().done(function(){c.deferred.resolve()})}}else c.width=c.canvas.width=b.width,c.height=c.canvas.height=b.height,c.deferred.resolve()};
SnaprFX.Canvas.prototype.place_image=function(){var b=$.Deferred();this.image.aspect=this.image.width/this.image.height;var c=0,a=0,d=this.image.width,f=this.image.height;if(this.options.size)if(this.options.aspect){var g;this.image.aspect>this.options.aspect?(this.height=this.canvas.height=this.options.size,this.width=this.canvas.width=this.height*this.options.aspect,g=this.image.width-this.image.height*this.options.aspect,c=g/2,d=this.image.width-g):(this.width=this.canvas.width=this.options.size,
this.height=this.canvas.height=this.width/this.options.aspect,g=this.image.height-this.image.width/this.options.aspect,a=g/2,f=this.image.height-g)}else 1<this.image.aspect?(this.width=this.canvas.width=this.options.size,this.height=this.canvas.height=this.width/this.image.aspect):(this.height=this.canvas.height=this.options.size,this.width=this.canvas.width=this.height*this.image.aspect);else this.width=this.canvas.width=this.options.width||this.image.width,this.height=this.canvas.height=this.options.height||
this.image.height;this.context.translate(this.canvas.width/2,this.canvas.height/2);this.context.rotate(this.options.rotation);this.context.drawImage(this.image,c,a,d,f,this.canvas.width/-2,this.canvas.height/-2,this.canvas.width,this.canvas.height);this.context.rotate(-this.options.rotation);this.context.translate(this.canvas.width/-2,this.canvas.height/-2);b.resolve();debug_logging&&console.timeEnd("get image");return b};
SnaprFX.Canvas.prototype.get_data=function(){var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);this.data=b;return b.data};SnaprFX.Canvas.prototype.put_data=function(b){this.data.data=b;this.context.putImageData(this.data,0,0);return this};SnaprFX.Canvas.prototype.get_data_url=function(){return this.canvas.toDataURL("image/jpeg",1)};SnaprFX.Canvas.prototype.clear=function(){this.canvas.width=this.canvas.width};
SnaprFX.Canvas.prototype.set_size=function(b,c){this.canvas.width!=b&&(this.width=b,this.options.width=b,this.canvas.width=b);this.canvas.height!=c&&(this.height=c,this.options.height=c,this.canvas.height=c);return this.image?this.place_image():$.Deferred().resolve()};SnaprFX.Canvas.prototype.clone=function(b){return new SnaprFX.Canvas($.extend({},this.options,b))};SnaprFX.Blender=function(b){debug_logging&&console.log(" - Blend:",b);this.mode=this.blend_modes[b];this.process=this.mode.rgb?function(c,a,b){a=this.mode.process(c,a);for(var f=[],g=R;g<=B;g++)f[g]=a[g]*b+c[g]*(1-b);return f}:function(c,a,b){for(var f=[],g=R;g<=B;g++)f[g]=this.mode.process(c[g],a[g]),f[g]=f[g]*b+c[g]*(1-b);return f}};
SnaprFX.Blender.prototype.blend_modes={normal:{rgb:!1,process:function(b,c,a){return c}},multiply:{rgb:!1,process:function(b,c,a){return b*c/255}},screen:{rgb:!1,process:function(b,c,a){return 255-((255-c)*(255-b)>>8)}},overlay:{rgb:!1,process:function(b,c,a){return 128>b?b*c*(2/255):255-(255-b)*(255-c)*(2/255)}},darken:{rgb:!1,process:function(b,c,a){b<c&&(c=b);return c}},lighten:{rgb:!1,process:function(b,c,a){b>c&&(c=b);return c}},color_dodge:{rgb:!1,process:function(b,c,a){b=(b<<8)/(255-c);return 255<
b||255==c?255:b}},color_burn:{rgb:!1,process:function(b,c,a){b=255-(255-b<<8)/c;return 0>b||0===c?0:b}},soft_light:{rgb:!1,process:function(b,c,a){return 128>b?((c>>1)+64)*b*(2/255):255-(191-(c>>1))*(255-b)*(2/255)}},hard_light:{rgb:!1,process:function(b,c,a){return 128>c?b*c*(2/255):255-(255-b)*(255-c)*(2/255)}},difference:{rgb:!1,process:function(b,c,a){b-=c;return 0>b?-b:b}},exclusion:{rgb:!1,process:function(b,c,a){return b-(b*(2/255)-1)*c}},hue:{rgb:!0,process:function(b,c,a){return c}},saturation:{rgb:!0,
process:function(b,c,a){return c}},color:{rgb:!0,process:function(b,c,a){b=SnaprFX.utils.rgbToHsl(b[0],b[1],b[2]);c=SnaprFX.utils.rgbToHsl(c[0],c[1],c[2]);return SnaprFX.utils.hslToRgb(c[0],c[1],b[2])}},luminosity:{rgb:!0,process:function(b,c,a){return c}},subtract:{rgb:!1,process:function(b,c,a){c=b-c;0>c&&(c=0);return c}},add:{rgb:!1,process:function(b,c,a){c=b+c;255<c&&(c=255);return c}},divide:{rgb:!1,process:function(b,c,a){return 255*(b/c)}},linear_burn:{rgb:!1,process:function(b,c,a){return 255>
b+c?0:b+c-255}}};SnaprFX.filters={};SnaprFX.filters.adjustment=function(b){debug_logging&&console.log(" - Adjustment:",b.adjustment.type);this.filter=new SnaprFX.filters[b.adjustment.type](b);this.whole_canvas=this.filter.whole_canvas;this.process=this.filter.process;this.deferred=$.Deferred().resolve()};
SnaprFX.filters.curves=function(b){this.curves=b.adjustment;this.splines={};var c=this;$.each(["rgb","red","green","blue"],function(a,b){if(0===c.curves[b].length)c.splines[b]={interpolate:function(a){return a}};else{var f=[],g=[];$.each(c.curves[b],function(a,c){f.push(c[0]);g.push(c[1])});c.splines[b]=new c.CubicSpline(f,g)}})};
SnaprFX.filters.curves.prototype.process=function(b,c){c[0]=this.filter.splines.red.interpolate(c[0]);c[1]=this.filter.splines.green.interpolate(c[1]);c[2]=this.filter.splines.blue.interpolate(c[2]);c[0]=this.filter.splines.rgb.interpolate(c[0]);c[1]=this.filter.splines.rgb.interpolate(c[1]);c[2]=this.filter.splines.rgb.interpolate(c[2]);return c};
SnaprFX.filters.curves.prototype.CubicSpline=function(){function b(c,a){var b,f,g,h,e,l,k,n,m,p;if(null!==c&&null!==a){k=c.length-1;h=[];m=[];l=[];n=[];p=[];f=[];b=[];g=[];this.max_out=a[0];this.min_out=a[0];this.max_in=c[0];this.min_in=c[0];for(e=0;0<=k?e<k:e>k;0<=k?e+=1:e-=1)h[e]=c[e+1]-c[e],this.max_out=a[e+1]>this.max_out?a[e+1]:this.max_out,this.min_out=a[e+1]<this.min_out?a[e+1]:this.min_out,this.max_in=c[e+1]>this.max_in?c[e+1]:this.max_in,this.min_in=c[e+1]<this.min_in?c[e+1]:this.min_in;
for(e=1;1<=k?e<k:e>k;1<=k?e+=1:e-=1)m[e]=3/h[e]*(a[e+1]-a[e])-3/h[e-1]*(a[e]-a[e-1]);l[0]=1;n[0]=0;p[0]=0;for(e=1;1<=k?e<k:e>k;1<=k?e+=1:e-=1)l[e]=2*(c[e+1]-c[e-1])-h[e-1]*n[e-1],n[e]=h[e]/l[e],p[e]=(m[e]-h[e-1]*p[e-1])/l[e];l[k]=1;p[k]=0;f[k]=0;for(e=l=k-1;0>=l?0>=e:0<=e;0>=l?e+=1:e-=1)f[e]=p[e]-n[e]*f[e+1],b[e]=(a[e+1]-a[e])/h[e]-h[e]*(f[e+1]+2*f[e])/3,g[e]=(f[e+1]-f[e])/(3*h[e]);this.x=c.slice(0,k+1);this.a=a.slice(0,k);this.b=b;this.c=f.slice(0,k);this.d=g}}b.prototype.derivative=function(){var c,
a,b,f,g;a=new this.constructor;a.x=this.x.slice(0,this.x.length);a.a=this.b.slice(0,this.b.length);g=this.c;b=0;for(f=g.length;b<f;b++)c=g[b],a.b=2*c;g=this.d;b=0;for(f=g.length;b<f;b++)c=g[b],a.c=3*c;c=0;for(b=this.d.length;0<=b?c<b:c>b;0<=b?c+=1:c-=1)a.d=0;return a};b.prototype.interpolate=function(c){if(c>=this.max_in)return this.max_out;if(c<=this.min_in)return this.min_out;var a,b;for(a=b=this.x.length-1;(0>=b?0>=a:0<=a)&&!(this.x[a]<=c);0>=b?a+=1:a-=1);c-=this.x[a];return this.a[a]+this.b[a]*
c+this.c[a]*Math.pow(c,2)+this.d[a]*Math.pow(c,3)};return b}();SnaprFX.filters.levels=function(b){var c=b.adjustment;this.interpolate=function(a){var b=c.white-c.black;return Math.pow((a-c.black)/b,1/c.mid)*b/(b/255)}};SnaprFX.filters.levels.prototype.process=function(b,c){c[R]=this.filter.interpolate(c[R]);c[G]=this.filter.interpolate(c[G]);c[B]=this.filter.interpolate(c[B]);return c};SnaprFX.filters.hue=function(b){this.hue=b.adjustment.amount};
SnaprFX.filters.hue.prototype.process=function(b,c){var a=SnaprFX.utils.rgbToHsl(c[R],c[G],c[B]);a[0]+=this.filter.hue/255;1<a[0]&&(a[0]-=1);0>a[0]&&(a[0]+=1);return SnaprFX.utils.hslToRgb(a[0],a[1],a[2])};SnaprFX.filters.saturation=function(b){this.saturation=b.adjustment.amount/100};
SnaprFX.filters.saturation.prototype.process=function(b,c){var a=SnaprFX.utils.rgbToHsl(c[R],c[G],c[B]),d;d=0>this.filter.saturation?a[1]*(this.filter.saturation+1):a[1]*(2*this.filter.saturation+1);d=Math.min(255,d);return SnaprFX.utils.hslToRgb(a[0],d,a[2])};SnaprFX.filters.lightness=function(b){this.lightness=b.adjustment.amount/100};
SnaprFX.filters.lightness.prototype.process=function(b,c){var a=this.filter.lightness,d=0>a?1+a:1-a,a=0>a?0:255*a;return[Math.min(c[R]*d+a,255),Math.min(c[G]*d+a,255),Math.min(c[B]*d+a,255)]};SnaprFX.filters.blur=function(b){this.whole_canvas=!0;this.amount=Math.max(0,Math.min(5,b.adjustment.amount))};
SnaprFX.filters.blur.prototype.process=function(b){var c=Math.round(b.width/2),a=Math.round(b.height/2),d=document.createElement("canvas");d.width=c;d.height=a;for(var f=Math.round(20*this.filter.amount),g=d.getContext("2d"),h=0;h<f;h++){var e=Math.max(1,Math.round(c-h)),l=Math.max(1,Math.round(a-h));g.clearRect(0,0,c,a);g.drawImage(b.canvas,0,0,b.width,b.height,0,0,e,l);b.context.drawImage(d,0,0,e,l,0,0,b.width,b.height)}};SnaprFX.filters.color=function(b){this.color=b.color.rgb;this.deferred=$.Deferred().resolve()};
SnaprFX.filters.color.prototype.process=function(b,c){return this.color};SnaprFX.filters.image=function(b,c){var a=this;a.url=b.image.image;a.width=c.canvas.width;a.height=c.canvas.height;a.canvas=new SnaprFX.Canvas({url:c.filter_pack.base_path+"filters/"+c.current_filter+"/"+a.url,width:a.width,height:a.height});a.deferred=$.Deferred();a.canvas.deferred.done(function(){a.pixels=a.canvas.get_data();a.deferred.resolve()})};
SnaprFX.filters.image.prototype.update=function(b,c){var a=this;console.log("updating",c.canvas.width);a.width=c.canvas.width;a.height=c.canvas.height;a.deferred=$.Deferred();a.canvas.set_size(a.width,a.height).done(function(){a.pixels=a.canvas.get_data();a.deferred.resolve()})};SnaprFX.filters.image.prototype.process=function(b,c){return[this.pixels[b],this.pixels[b+1],this.pixels[b+2],this.pixels[b+3]]};var debug_borders=!1;SnaprFX.prototype.add_text=function(b){b.filter=new SnaprFX.filters.text(b,this);this.filter_specs[this.current_filter].layers.push(b)};SnaprFX.filters.text=function(b,c){c.text.push(this);this.slug=b.slug;this.text_style=b.text.style;this.text=c.options.text&&c.options.text[b.slug]||b.text.default_value;this.canvas=new SnaprFX.Canvas({width:c.canvas.width,height:c.canvas.height});this.update(b,c)};
SnaprFX.filters.text.prototype.calculate_position=function(b,c){this.x_scale_factor=this.canvas.width/c.filter_specs[c.current_filter].target_canvas.width;this.y_scale_factor=this.canvas.height/c.filter_specs[c.current_filter].target_canvas.height;this.position=b.position&&b.position.bbox?{top:b.position.bbox.top*this.y_scale_factor,bottom:b.position.bbox.bottom*this.y_scale_factor,left:b.position.bbox.left*this.x_scale_factor,right:b.position.bbox.right*this.x_scale_factor}:{top:0,bottom:this.canvas.height,
left:0,right:this.canvas.width};b.position&&(this.position.x=b.position.x*this.x_scale_factor,this.position.y=b.position.y*this.y_scale_factor);this.bbox={top:this.position.top,bottom:this.position.bottom,left:this.position.left,right:this.position.right}};
SnaprFX.filters.text.prototype.set_canvas_font=function(){this.text_element.css("font-size",parseInt(this.text_element.css("font-size"),10)*this.render_scale);this.text_element.css("line-height",parseInt(this.text_element.css("line-height"),10)*this.render_scale+"px");this.canvas.context.font=this.text_element.css("font");this.text_element.css("font-size",parseInt(this.text_element.css("font-size"),10)/this.render_scale);this.text_element.css("line-height",parseInt(this.text_element.css("line-height"),
10)/this.render_scale+"px")};
SnaprFX.filters.text.prototype.update=function(b,c){function a(a,c){for(var b=a.split("\n"),f=[],e=0,g=0;g<b.length;g++){var h=b[g].split(" ");f[e]=h[0];for(var l=1;l<h.length;l++)d.canvas.context.measureText(f[e]+" "+h[l]).width>c?(e++,f[e]=h[l]):f[e]=f[e]+" "+h[l];e++}return f}var d=this;d.rendered=(!1!==c.options.render_text||c.render_options.render_text||c.render_options.output)&&(!c.render_options.editable||c.options.disable_text_edit);d.spec=b;d.dragable=b.position&&b.position.dragable;d.deferred=
$.Deferred();d.canvas.set_size(c.canvas.width,c.canvas.height);d.canvas.clear();d.calculate_position(b,c);d.create_overlay(b,c);d.text=d.text_element.html().replace(/<br\/?>/g,"\n").replace(/&nbsp;/g," ").replace(/<.*?>/g,"");d.text_element.html(d.text.replace(/\n/g,"<br>"));d.text_style.fillStyle=d.text_element.css("color");d.text_style.textAlign=d.element.css("text-align");d.render_scale=d.canvas.height/c.elements.overlay.height();d.set_canvas_font();d.canvas.context.textAlign=d.text_style.textAlign||
"left";d.canvas.context.textBaseline=d.text_style.textBaseline||"top";d.canvas.context.fillStyle=d.text_style.fillStyle;d.text_style.fontSize=parseInt(d.text_element.css("font-size"),10);d.text_style.lineHeight=parseInt(d.text_element.css("line-height"),10);var f=d.element.position();d.position.left=f.left;d.position.top=f.top;d.position.right=f.left+d.element.width();d.position.bottom=f.top+d.element.height();for(var f=d.position.right-d.position.left,g=Math.round(d.position.bottom-d.position.top),
h=a(d.text,f),e=1E3;e&&(!h||(h.length-1)*d.text_style.lineHeight+d.text_style.fontSize>g);)e--,d.text_style.fontSize*=0.8,d.text_element.css("font-size",d.text_style.fontSize),d.text_style.lineHeight*=0.8,d.text_element.css("line-height",d.text_style.lineHeight+"px"),d.set_canvas_font(),h=a(d.text,f);e||console.warn("render shrunk text 1000 times without success!");switch(d.text_style.textAlign){case "end":case "right":e=d.position.right;break;case "center":e=f/2+d.position.left;break;default:e=d.position.left}e*=
d.render_scale;switch(d.text_style.textBaseline){case "hanging":case "alphabetic":case "ideographic":case "bottom":g=d.position.bottom-d.text_style.lineHeight*(h.length-1);break;case "middle":g=g/2+d.position.top-d.text_style.lineHeight*(h.length-1)/2;break;default:g=d.position.top}g*=d.render_scale;if(d.slug!==c.render_options.active_text&&!b.removed)for(var l=0;l<h.length;l++)debug_borders&&d.canvas.context.strokeRect(d.position.left*d.x_scale_factor*d.render_scale,g+l*d.text_style.lineHeight*d.render_scale,
f*d.render_scale,d.text_style.lineHeight*d.render_scale),d.canvas.context.fillText(h[l],e,g+l*d.text_style.lineHeight*d.render_scale,f);d.pixels=d.canvas.get_data();d.deferred.resolve()};
SnaprFX.filters.text.prototype.create_overlay=function(b,c){var a=this;if(!a.element||!jQuery.contains(document.documentElement,a.element[0])){a.overlay=c.elements.overlay;var d={position:"absolute",left:a.position.left,top:a.position.top,width:a.position.right-a.position.left,height:a.position.bottom-a.position.top,"text-align":a.text_style.textAlign};if(a.position.x)switch(a.text_style.textAlign){case "end":case "right":d.width=a.position.x;break;case "center":a.position.right-a.position.x<a.position.x-
a.position.left?(d.width=2*(a.position.right-a.position.x),d.left=a.position.right-d.width):d.width=2*(a.position.x-a.position.left);break;default:d.left=a.position.x,d.width=a.position.right-a.position.x}if(a.position.y)switch(a.text_style.textBaseline){case "hanging":case "alphabetic":case "ideographic":case "bottom":d.height=a.position.y;break;case "middle":a.position.bottom-a.position.y<a.position.y-a.position.top?(d.height=2*(a.position.bottom-a.position.y),d.top=a.position.bottom-d.height):
d.height=2*(a.position.y-a.position.top);break;default:d.top=a.position.y,d.height=a.bbox.bottom-d.top}d["line-height"]=d.height+"px";a.element=$('<div class="fx-text">').css(d);a.rendered&&(!1!==c.options.render_text||c.render_options.render_text)&&a.element.addClass("fx-text-rendered");a.wrapper=$('<div class="fx-text-wrapper">').css({"line-height":"normal","vertical-align":a.text_style.textBaseline});a.text_element=$('<div class="fx-text-inner" data-layer="'+a.slug+'">').css({font:a.text_style.font,
color:a.text_style.fillStyle}).text(a.text).on("click",function(){if(!c.options.disable_text_edit){var d=a.element.hasClass("fx-active"),g=a.element.hasClass("fx-text-rendered"),h=a.overlay.find(".fx-active").not(a.element);h.length&&(a.deactivate(h),c.active_text=null);d||(a.element.addClass("fx-active").removeClass("fx-text-rendered").trigger("activate",b),c.active_text=a);c.elements.overlay.addClass("fx-editing-text").removeClass("fx-editing-sticker");g&&c.unrender_editables()}}).on("dblclick",
function(){a.editable=!0;a.element.addClass("fx-editable");a.text_element.attr("contenteditable",!0).focus()}).on("keyup",function(){a.check_size()});a.element.append(a.wrapper);a.wrapper.append(a.text_element);a.wrapper.append($('<a class="fx-delete-layer fx-text-button">\u2717</a>').css({position:"absolute",top:0,left:0}).click(function(){a.remove()}));a.wrapper.append($('<a class="fx-render-layer fx-text-button">\u2714</a>').css({position:"absolute",top:0,right:0}).click(function(){!1!==c.options.render_text||
c.render_options.render_text?c.rerender_editables():a.deactivate()}));a.wrapper.append($('<span class="fx-text-edit-note"><span class="fx-text-edit-note-editing">Done editing</span><span class="fx-text-edit-note-not-editing">Double click to edit</span></span>').click(function(){!1!==c.options.render_text||c.render_options.render_text?c.rerender_editables():a.deactivate()}));a.dragable&&(a.mousemove_drag=function(c){if(!a.rendered&&!a.editable){var b={},d,e=a.bbox.right-a.bbox.left;switch(a.text_style.textAlign){case "end":case "right":b.width=
Math.min(c.pageX+a.drag_from.right-a.bbox.left,e);break;case "center":d=(a.drag_from.right-a.drag_from.left)/2;d=c.pageX+d+a.bbox.left;b.width=2*(d-a.bbox.left-a.bbox.left);b.width>e&&(b.left=a.bbox.left+(b.width-e),b.left=Math.min(b.left,a.bbox.left+e),b.width=e-(b.left-a.bbox.left));break;default:b.left=Math.max(a.bbox.left,c.pageX-a.drag_from.left),b.width=a.bbox.right-b.left}e=a.bbox.bottom-a.bbox.top;d=a.text_element.innerHeight()-18;switch(a.text_style.textBaseline){case "hanging":case "alphabetic":case "ideographic":case "bottom":b.height=
Math.min(c.pageY+a.drag_from.bottom-a.bbox.top,e);break;case "middle":d=(a.drag_from.bottom-a.drag_from.top)/2;d=c.pageY+d+a.bbox.top;b.height=2*(d-a.bbox.top-a.bbox.top);b.height>e&&(b.top=a.bbox.top+(b.height-e),b.top=Math.min(b.top,a.bbox.top+e-a.text_style.lineHeight),b.height=e-(b.top-a.bbox.top));break;default:b.top=Math.min(a.bbox.bottom-d,c.pageY-a.drag_from.top),b.top=Math.max(a.bbox.top,b.top),b.height=a.bbox.bottom-b.top}b.height=Math.max(b.height,a.text_style.lineHeight);b["line-height"]=
b.height+"px";a.element.css(b)}},a.mouseup=function(){c.elements.wrapper.off("mousemove",a.mousemove_drag)},c.elements.wrapper.on("mouseup",a.mouseup),a.element.on("mousedown",function(b){if(!a.rendered){var d=parseInt(a.element.css("left"),10),h=parseInt(a.element.css("top"),10),e=parseInt(a.element.css("width"),10),l=parseInt(a.element.css("height"),10);a.drag_from={left:b.pageX-d,right:d+e-b.pageX,top:b.pageY-h,bottom:h+l-b.pageY,event:b};c.elements.wrapper.on("mousemove",a.mousemove_drag)}c.elements.overlay.addClass("fx-editing-text").removeClass("fx-editing-sticker")}));
a.text_style.fontSize=parseInt(a.text_element.css("font-size"),10)*a.y_scale_factor;a.text_element.css("font-size",a.text_style.fontSize);a.text_style.lineHeight=a.text_element.css("line-height");"%"==a.text_style.lineHeight.substr(-1)?a.text_style.lineHeight=parseInt(a.text_style.lineHeight,10)/100*a.text_style.fontSize:a.text_style.lineHeight=parseInt(a.text_style.lineHeight,10)*a.y_scale_factor;a.text_element.css("line-height",a.text_style.lineHeight+"px").data("line-height-multiplier",a.text_style.lineHeight/
a.text_style.fontSize);a.overlay.append(a.element)}};SnaprFX.filters.text.prototype.change_style=function(b){this.text_element.css(b);"text-align"in b&&this.element.css("text-align",b["text-align"]);this.check_size()};
SnaprFX.filters.text.prototype.check_size=function(b){this.text_style.fontSize=parseInt(this.text_element.css("font-size"),10);this.text_style.lineHeight=parseInt(this.text_element.css("line-height"),10);for(b=1E3;b&&(this.text_element.width()>this.element.width()||this.text_element.height()>Math.round(this.element.height()));)b--,this.text_style.fontSize*=0.99,this.text_element.css("font-size",this.text_style.fontSize),this.text_style.lineHeight*=0.99,this.text_element.css("line-height",this.text_style.lineHeight+
"px");b||console.warn("check_size shrunk text 1000 times without success!")};SnaprFX.filters.text.prototype.remove=function(){this.element.hide();this.spec.removed=!0};SnaprFX.filters.text.prototype.unrender=function(){this.element.removeClass("fx-text-rendered")};SnaprFX.filters.text.prototype.rerender=function(){this.element.addClass("fx-text-rendered")};
SnaprFX.filters.text.prototype.deactivate=function(b){(b||this.element).removeClass("fx-editable").removeClass("fx-active").trigger("deactivate").find(".fx-text-inner").attr("contenteditable",!1);this.editable=!1};SnaprFX.filters.text.prototype.process=function(b,c){return!this.rendered?[0,0,0,0]:[this.pixels[b],this.pixels[b+1],this.pixels[b+2],this.pixels[b+3]]};var css=".fx-active-border{margin:-2px;border:solid rgba(240,240,240,.8) 2px;border-radius:4px;box-shadow:0 0 3px rgba(0,0,0,.3)}.fx-text{pointer-events:none}.fx-text.fx-text-rendered{opacity:0}.fx-text .fx-text-wrapper{pointer-events:auto;position:relative;display:inline-block;margin:-9px}.fx-text .fx-text-inner{user-select:none;-webkit-user-select:none;-moz-user-select:none;padding:9px;outline:0;display:inline-block}.fx-text.fx-editable .fx-text-inner{user-select:text;-webkit-user-select:text;-moz-user-select:text}.fx-text .fx-text-button{display:none}.fx-text .fx-text-edit-note{display:none;background:#fff;color:#000;position:absolute;height:12px;top:0;left:10%;right:10%}.fx-text .fx-text-edit-note .fx-text-edit-note-not-editing{display:block}.fx-text .fx-text-edit-note .fx-text-edit-note-editing{display:none}.fx-text.fx-editable .fx-text-edit-note-not-editing{display:none}.fx-text.fx-editable .fx-text-edit-note-editing{display:block}.fx-text.fx-active .fx-text-edit-note{display:block}.fx-text.fx-active .fx-text-inner{margin:-2px;border:solid rgba(240,240,240,.8) 2px;border-radius:4px;box-shadow:0 0 3px rgba(0,0,0,.3)}.fx-text.fx-active .fx-text-button{display:block}.fx-sticker{padding:.5em;-webkit-user-select:none;opacity:1;transition:0}.fx-sticker .fx-sticker-image{width:100%;height:100%}.fx-sticker.fx-sticker-rendered{opacity:0;transition:opacity .4s linear}.fx-sticker .fx-sticker-handle{display:none}.fx-sticker.fx-active{margin:-2px;border:solid rgba(240,240,240,.8) 2px;border-radius:4px;box-shadow:0 0 3px rgba(0,0,0,.3)}.fx-sticker.fx-active .fx-sticker-handle{display:block}.fx-sticker .fx-remove-sticker{top:0;left:0;background:#000;color:#fff}.fx-sticker .fx-render-sticker{top:0;right:0}.fx-sticker .fx-scale-sticker{bottom:0;right:0;font-weight:700}.fx-text-disabled .fx-text{pointer-events:none}.fx-stickers-disabled .fx-sticker{pointer-events:none}.fx-editing-text .fx-text{z-index:2}.fx-editing-text .fx-text.fx-active{z-index:3}.fx-editing-sticker .fx-sticker{z-index:2}.fx-editing-sticker .fx-sticker.fx-active{z-index:3}.fx-text-button,.fx-sticker-handle{background-color:#ff0;padding:4px;display:block;min-width:12px;min-height:12px;border-radius:20px;border:#fff solid 2px;font-size:12px;line-height:12px;text-align:center;color:#000;margin:-12px;box-shadow:0 0 3px rgba(0,0,0,.3);cursor:pointer;position:absolute}.fx-delete-layer{background-color:#000;color:#fff}",
htmlDiv=document.createElement("div");htmlDiv.innerHTML="<p>x</p><style>"+css+"</style>";document.getElementsByTagName("head")[0].appendChild(htmlDiv.childNodes[1]);
